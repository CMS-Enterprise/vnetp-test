<section class="tenant-infra">
  <div class="toolbar d-flex justify-content-between align-items-center mb-3 p-3 bg-light border-bottom">
    <div class="d-flex align-items-center">
      <button class="btn btn-outline-secondary mr-3" (click)="goBack()">
        <fa-icon [icon]="['fas', 'arrow-left']" class="mr-2"></fa-icon>
        Back to Tenant Select
      </button>
      <div>
        <h4 class="mb-1">Tenant Infrastructure ({{ mode | uppercase }})</h4>
        <small class="text-muted" *ngIf="mode === 'edit'">
          Viewing tenant: <strong>{{ tenantId }}</strong> <span class="badge badge-info">Read Only</span>
        </small>
        <small class="text-muted" *ngIf="mode === 'create'">
          Creating a new tenant configuration
          <span *ngIf="hasUnsavedChanges" class="badge badge-warning ml-2">Unsaved Changes</span>
        </small>
      </div>
    </div>
    <div class="d-flex align-items-center">
      <button class="btn btn-outline-secondary mr-2" (click)="toggleLeftPanel()" title="Toggle input panel">
        <fa-icon [icon]="leftPanelCollapsed ? ['fas', 'chevron-right'] : ['fas', 'chevron-left']"></fa-icon>
      </button>
      <div class="btn-group mr-2">
        <button class="btn btn-primary" *ngIf="mode === 'create'" (click)="validate()" [disabled]="isSubmitting">
          <fa-icon [icon]="['fas', 'check']" class="mr-1"></fa-icon>
          Validate
        </button>
        <button class="btn btn-info" (click)="getGraph()" [disabled]="isSubmitting">Graph</button>
        <button class="btn btn-success" *ngIf="mode === 'create'" (click)="saveConfig()" [disabled]="isSubmitting">
          <fa-icon [icon]="['fas', 'save']" class="mr-1"></fa-icon>
          Save
        </button>
      </div>
    </div>
  </div>

  <!-- Loading indicator for edit mode -->
  <div *ngIf="isLoadingConfig" class="text-center py-4">
    <fa-icon class="icon text-primary" [icon]="['fas', 'spinner']" [spin]="true" style="font-size: 2rem"></fa-icon>
    <div class="mt-2 text-muted">Loading tenant configuration...</div>
  </div>

  <div class="row" *ngIf="!isLoadingConfig">
    <div class="col-lg-4 col-md-5" *ngIf="!leftPanelCollapsed" [@slideInOut]>
      <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
          <a
            class="nav-link"
            [class.active]="activeTab === 'tenant'"
            [class.text-danger]="tenantTabHasErrors"
            (click)="setActiveTab('tenant')"
          >
            Tenant
            <span *ngIf="tenantTabHasErrors" class="badge badge-danger ml-1">!</span>
          </a>
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            [class.active]="activeTab === 'firewalls'"
            [class.text-danger]="firewallsTabHasErrors"
            (click)="setActiveTab('firewalls')"
          >
            External Firewalls
            <span *ngIf="firewallsTabHasErrors" class="badge badge-danger ml-1">!</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" [class.active]="activeTab === 'vrfs'" [class.text-danger]="vrfsTabHasErrors" (click)="setActiveTab('vrfs')">
            VRFs
            <span *ngIf="vrfsTabHasErrors" class="badge badge-danger ml-1">!</span>
          </a>
        </li>
      </ul>

      <!-- Tenant Form -->
      <div *ngIf="activeTab === 'tenant'">
        <div class="form-group">
          <label>Name</label>
          <input
            class="form-control"
            [class.is-invalid]="hasFieldError('tenant.name')"
            [disabled]="mode === 'edit'"
            [(ngModel)]="config.tenant.name"
            (ngModelChange)="onConfigMutated()"
          />
          <div *ngIf="hasFieldError('tenant.name')" class="invalid-feedback d-block">
            {{ getFieldError('tenant.name') }}
          </div>
        </div>
        <div class="form-group">
          <label>Environment</label>
          <ng-select
            [ngClass]="{ 'is-invalid': hasFieldError('tenant.environmentId') }"
            [disabled]="mode === 'edit'"
            [(ngModel)]="config.tenant.environmentId"
            (ngModelChange)="onConfigMutated()"
            [items]="environments"
            bindLabel="name"
            bindValue="id"
            placeholder="Select an environment..."
            [clearable]="false"
          >
          </ng-select>
          <div *ngIf="hasFieldError('tenant.environmentId')" class="invalid-feedback d-block">
            {{ getFieldError('tenant.environmentId') }}
          </div>
        </div>
        <div class="form-group">
          <label>Alias</label>
          <input class="form-control" [disabled]="mode === 'edit'" [(ngModel)]="config.tenant.alias" (ngModelChange)="onConfigMutated()" />
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea
            class="form-control"
            rows="3"
            [disabled]="mode === 'edit'"
            [(ngModel)]="config.tenant.description"
            (ngModelChange)="onConfigMutated()"
          ></textarea>
        </div>
      </div>

      <!-- Firewalls List + Detail -->
      <div *ngIf="activeTab === 'firewalls'">
        <div class="d-flex mb-2" *ngIf="mode === 'create'">
          <button class="btn btn-sm btn-outline-primary" (click)="addFirewall()">Add Firewall</button>
        </div>
        <ul class="list-group mb-2">
          <li
            class="list-group-item p-2"
            *ngFor="let fw of config.externalFirewalls; let i = index; trackBy: trackByIdx"
            [class.active]="i === selectedFirewallIdx"
            [class.border-danger]="hasFirewallErrors(i)"
            (click)="selectedFirewallIdx = i"
            style="cursor: pointer"
          >
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ fw.name || '(unnamed)' }}</strong>
                <span *ngIf="hasFirewallErrors(i)" class="badge badge-danger ml-1">!</span>
              </div>
              <button class="btn btn-sm btn-outline-danger" *ngIf="mode === 'create'" (click)="$event.stopPropagation(); removeFirewall(i)">
                Remove
              </button>
            </div>
          </li>
        </ul>
        <div *ngIf="config.externalFirewalls.length">
          <div class="card">
            <div class="card-body">
              <h6 class="card-title">Firewall Details</h6>
              <div class="form-row">
                <div class="form-group col-6">
                  <label>Name</label>
                  <input
                    class="form-control"
                    [class.is-invalid]="hasFieldError('externalFirewalls.' + selectedFirewallIdx + '.name')"
                    [disabled]="mode === 'edit'"
                    [(ngModel)]="config.externalFirewalls[selectedFirewallIdx].name"
                    (ngModelChange)="onConfigMutated()"
                  />
                  <!-- Debug: checking path externalFirewalls.{{selectedFirewallIdx}}.name -->
                  <div *ngIf="hasFieldError('externalFirewalls.' + selectedFirewallIdx + '.name')" class="invalid-feedback d-block">
                    {{ getFieldError('externalFirewalls.' + selectedFirewallIdx + '.name') }}
                  </div>
                </div>
                <div class="form-group col-6">
                  <label>Device Type</label>
                  <select
                    class="form-control"
                    [disabled]="mode === 'edit'"
                    [(ngModel)]="config.externalFirewalls[selectedFirewallIdx].firewallDeviceType"
                    (ngModelChange)="onConfigMutated()"
                  >
                    <option>PaloAlto</option>
                    <option>CiscoAsa</option>
                  </select>
                  <div
                    *ngIf="hasFieldError('externalFirewalls.' + selectedFirewallIdx + '.firewallDeviceType')"
                    class="invalid-feedback d-block"
                  >
                    {{ getFieldError('externalFirewalls.' + selectedFirewallIdx + '.firewallDeviceType') }}
                  </div>
                </div>
                <div class="form-group col-6">
                  <label>VSYS/Context Name</label>
                  <input
                    class="form-control"
                    [class.is-invalid]="hasFieldError('externalFirewalls.' + selectedFirewallIdx + '.vsysName')"
                    [disabled]="mode === 'edit'"
                    [(ngModel)]="config.externalFirewalls[selectedFirewallIdx].vsysName"
                    (ngModelChange)="onConfigMutated()"
                  />
                  <div *ngIf="hasFieldError('externalFirewalls.' + selectedFirewallIdx + '.vsysName')" class="invalid-feedback d-block">
                    {{ getFieldError('externalFirewalls.' + selectedFirewallIdx + '.vsysName') }}
                  </div>
                </div>
                <div class="form-group" [ngClass]="config.externalFirewalls[selectedFirewallIdx].bgpAsnAutoGenerate ? 'col-12' : 'col-8'">
                  <div class="form-check">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="fwBgpAuto"
                      [disabled]="mode === 'edit'"
                      [(ngModel)]="config.externalFirewalls[selectedFirewallIdx].bgpAsnAutoGenerate"
                      (ngModelChange)="onConfigMutated()"
                    />
                    <label class="form-check-label" for="fwBgpAuto">Auto-allocate BGP ASN</label>
                  </div>
                </div>
                <div class="form-group col-4" *ngIf="!config.externalFirewalls[selectedFirewallIdx].bgpAsnAutoGenerate">
                  <label>BGP ASN</label>
                  <input
                    type="number"
                    class="form-control form-control-sm"
                    [class.is-invalid]="hasFieldError('externalFirewalls.' + selectedFirewallIdx + '.bgpAsn')"
                    [(ngModel)]="config.externalFirewalls[selectedFirewallIdx].bgpAsn"
                    (ngModelChange)="onConfigMutated()"
                    min="1"
                    max="4294967294"
                    placeholder="e.g. 65001"
                  />
                  <div *ngIf="hasFieldError('externalFirewalls.' + selectedFirewallIdx + '.bgpAsn')" class="invalid-feedback d-block">
                    {{ getFieldError('externalFirewalls.' + selectedFirewallIdx + '.bgpAsn') }}
                  </div>
                </div>
              </div>

              <div class="d-flex justify-content-between align-items-center mt-2">
                <h6 class="mb-0">External VRF Connections</h6>
                <button
                  class="btn btn-sm btn-outline-primary"
                  *ngIf="mode === 'create'"
                  (click)="addExternalVrfConnection(selectedFirewallIdx)"
                >
                  Add Connection
                </button>
              </div>
              <div class="mt-2" *ngFor="let c of config.externalFirewalls[selectedFirewallIdx].externalVrfConnections; let j = index">
                <div class="border rounded p-2 mb-2" [class.border-danger]="hasExternalVrfConnectionErrors(selectedFirewallIdx, j)">
                  <div class="form-row">
                    <div class="form-group col-6">
                      <label>Name</label>
                      <input
                        class="form-control"
                        [class.is-invalid]="
                          hasFieldError('externalFirewalls.' + selectedFirewallIdx + '.externalVrfConnections.' + j + '.name')
                        "
                        [(ngModel)]="c.name"
                        (ngModelChange)="onConfigMutated()"
                      />
                      <div
                        *ngIf="hasFieldError('externalFirewalls.' + selectedFirewallIdx + '.externalVrfConnections.' + j + '.name')"
                        class="invalid-feedback d-block"
                      >
                        {{ getFieldError('externalFirewalls.' + selectedFirewallIdx + '.externalVrfConnections.' + j + '.name') }}
                      </div>
                    </div>
                    <div class="form-group col-6">
                      <label>External VRF</label>
                      <ng-select
                        [ngClass]="{
                          'is-invalid': hasFieldError(
                            'externalFirewalls.' + selectedFirewallIdx + '.externalVrfConnections.' + j + '.externalVrf'
                          )
                        }"
                        [(ngModel)]="c.externalVrf"
                        (ngModelChange)="onConfigMutated()"
                        [items]="externalVrfOptions"
                        placeholder="Select an external VRF..."
                        [clearable]="true"
                      >
                      </ng-select>
                      <div
                        *ngIf="hasFieldError('externalFirewalls.' + selectedFirewallIdx + '.externalVrfConnections.' + j + '.externalVrf')"
                        class="invalid-feedback d-block"
                      >
                        {{ getFieldError('externalFirewalls.' + selectedFirewallIdx + '.externalVrfConnections.' + j + '.externalVrf') }}
                      </div>
                    </div>
                    <div class="form-group col-6">
                      <div class="form-check">
                        <input
                          type="checkbox"
                          class="form-check-input"
                          [id]="'defrt' + j"
                          [disabled]="mode === 'edit'"
                          [(ngModel)]="c.injectDefaultRouteFromExternalVrf"
                          (ngModelChange)="onConfigMutated()"
                        />
                        <label class="form-check-label" [for]="'defrt' + j">Inject Default Route</label>
                      </div>
                    </div>
                    <div class="form-group col-6">
                      <div class="form-check">
                        <input
                          type="checkbox"
                          class="form-check-input"
                          [id]="'allow' + j"
                          [disabled]="mode === 'edit'"
                          [(ngModel)]="c.allowAllRoutesFromExternalVrf"
                          (ngModelChange)="onConfigMutated()"
                        />
                        <label class="form-check-label" [for]="'allow' + j">Allow All Routes From External VRF</label>
                      </div>
                    </div>
                    <div class="form-group col-6">
                      <div class="form-check">
                        <input
                          type="checkbox"
                          class="form-check-input"
                          [id]="'host' + j"
                          [disabled]="mode === 'edit'"
                          [(ngModel)]="c.advertiseHostBasedRoutesToExternalVrf"
                          (ngModelChange)="onConfigMutated()"
                        />
                        <label class="form-check-label" [for]="'host' + j">Advertise Host-Based Routes</label>
                      </div>
                    </div>
                    <div class="form-group col-6">
                      <div class="form-check">
                        <input
                          type="checkbox"
                          class="form-check-input"
                          [id]="'all' + j"
                          [disabled]="mode === 'edit'"
                          [(ngModel)]="c.advertiseAllRoutesToExternalVrf"
                          (ngModelChange)="onConfigMutated()"
                        />
                        <label class="form-check-label" [for]="'all' + j">Advertise All Routes</label>
                      </div>
                    </div>
                  </div>
                  <div class="text-right">
                    <button
                      class="btn btn-sm btn-outline-danger"
                      *ngIf="mode === 'create'"
                      (click)="removeExternalVrfConnection(selectedFirewallIdx, j)"
                    >
                      Remove
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- VRFs List + Detail -->
      <div *ngIf="activeTab === 'vrfs'">
        <div class="d-flex mb-2" *ngIf="mode === 'create'">
          <button class="btn btn-sm btn-outline-primary" (click)="addVrf()">Add VRF</button>
        </div>
        <ul class="list-group mb-2">
          <li
            class="list-group-item p-2"
            *ngFor="let v of config.vrfs; let i = index; trackBy: trackByIdx"
            [class.active]="i === selectedVrfIdx"
            [class.border-danger]="hasVrfErrors(i)"
            (click)="selectedVrfIdx = i"
            style="cursor: pointer"
          >
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ v.name || '(unnamed)' }}</strong>
                <span *ngIf="hasVrfErrors(i)" class="badge badge-danger ml-1">!</span>
              </div>
              <div *ngIf="mode === 'create'" class="btn-group btn-group-sm">
                <button
                  class="btn btn-outline-secondary"
                  [disabled]="i === 0"
                  (click)="$event.stopPropagation(); moveVrfUp(i)"
                  title="Move up"
                >
                  ↑
                </button>
                <button
                  class="btn btn-outline-secondary"
                  [disabled]="i === config.vrfs.length - 1"
                  (click)="$event.stopPropagation(); moveVrfDown(i)"
                  title="Move down"
                >
                  ↓
                </button>
                <button class="btn btn-outline-danger" (click)="$event.stopPropagation(); removeVrf(i)">Remove</button>
              </div>
            </div>
          </li>
        </ul>
        <div *ngIf="config.vrfs.length">
          <div class="card">
            <div class="card-body">
              <h6 class="card-title">VRF Details</h6>
              <div class="form-row">
                <div class="form-group col-4">
                  <label>Name</label>
                  <input
                    class="form-control"
                    [class.is-invalid]="hasFieldError('vrfs.' + selectedVrfIdx + '.name')"
                    [(ngModel)]="config.vrfs[selectedVrfIdx].name"
                    (ngModelChange)="onConfigMutated()"
                  />
                  <div *ngIf="hasFieldError('vrfs.' + selectedVrfIdx + '.name')" class="invalid-feedback d-block">
                    {{ getFieldError('vrfs.' + selectedVrfIdx + '.name') }}
                  </div>
                </div>
                <div class="form-group col-4">
                  <label>Alias</label>
                  <input
                    class="form-control"
                    [disabled]="mode === 'edit'"
                    [(ngModel)]="config.vrfs[selectedVrfIdx].alias"
                    (ngModelChange)="onConfigMutated()"
                  />
                </div>
                <div class="form-group col-4">
                  <label>Max External Routes</label>
                  <input
                    type="number"
                    class="form-control"
                    [disabled]="mode === 'edit'"
                    [(ngModel)]="config.vrfs[selectedVrfIdx].maxExternalRoutes"
                    (ngModelChange)="onConfigMutated()"
                  />
                </div>
                <div class="form-group" [ngClass]="config.vrfs[selectedVrfIdx].bgpAsnAutoGenerate ? 'col-12' : 'col-8'">
                  <div class="form-check">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="vrfBgpAuto"
                      [disabled]="mode === 'edit'"
                      [(ngModel)]="config.vrfs[selectedVrfIdx].bgpAsnAutoGenerate"
                      (ngModelChange)="onConfigMutated()"
                    />
                    <label class="form-check-label" for="vrfBgpAuto">Auto-allocate BGP ASN</label>
                  </div>
                </div>
                <div class="form-group col-4" *ngIf="!config.vrfs[selectedVrfIdx].bgpAsnAutoGenerate">
                  <label>BGP ASN</label>
                  <input
                    type="number"
                    class="form-control form-control-sm"
                    [class.is-invalid]="hasFieldError('vrfs.' + selectedVrfIdx + '.bgpAsn')"
                    [(ngModel)]="config.vrfs[selectedVrfIdx].bgpAsn"
                    (ngModelChange)="onConfigMutated()"
                    min="1"
                    max="4294967294"
                    placeholder="e.g. 65001"
                  />
                  <div *ngIf="hasFieldError('vrfs.' + selectedVrfIdx + '.bgpAsn')" class="invalid-feedback d-block">
                    {{ getFieldError('vrfs.' + selectedVrfIdx + '.bgpAsn') }}
                  </div>
                </div>
              </div>

              <div class="d-flex justify-content-between align-items-center mt-2">
                <h6 class="mb-0">Service Graphs</h6>
                <button class="btn btn-sm btn-outline-primary" *ngIf="mode === 'create'" (click)="addServiceGraph(selectedVrfIdx)">
                  Add Service Graph
                </button>
              </div>
              <div class="mt-2" *ngFor="let sg of config.vrfs[selectedVrfIdx].serviceGraphs; let j = index">
                <div class="border rounded p-2 mb-2" [class.border-danger]="hasServiceGraphErrors(selectedVrfIdx, j)">
                  <div class="form-row">
                    <div class="form-group col-6">
                      <label>Name</label>
                      <input
                        class="form-control"
                        [class.is-invalid]="hasFieldError('vrfs.' + selectedVrfIdx + '.serviceGraphs.' + j + '.name')"
                        [disabled]="mode === 'edit'"
                        [(ngModel)]="sg.name"
                        (ngModelChange)="onConfigMutated()"
                      />
                      <div
                        *ngIf="hasFieldError('vrfs.' + selectedVrfIdx + '.serviceGraphs.' + j + '.name')"
                        class="invalid-feedback d-block"
                      >
                        {{ getFieldError('vrfs.' + selectedVrfIdx + '.serviceGraphs.' + j + '.name') }}
                      </div>
                    </div>

                    <div class="form-group col-6">
                      <label>Firewall Name</label>
                      <input
                        class="form-control"
                        [class.is-invalid]="hasFieldError('vrfs.' + selectedVrfIdx + '.serviceGraphs.' + j + '.serviceGraphFirewall.name')"
                        [disabled]="mode === 'edit'"
                        [(ngModel)]="sg.serviceGraphFirewall.name"
                        (ngModelChange)="onConfigMutated()"
                      />
                      <div
                        *ngIf="hasFieldError('vrfs.' + selectedVrfIdx + '.serviceGraphs.' + j + '.serviceGraphFirewall.name')"
                        class="invalid-feedback d-block"
                      >
                        {{ getFieldError('vrfs.' + selectedVrfIdx + '.serviceGraphs.' + j + '.serviceGraphFirewall.name') }}
                      </div>
                    </div>
                    <div class="form-group col-6">
                      <label>Device Type</label>
                      <select
                        class="form-control"
                        [disabled]="mode === 'edit'"
                        [(ngModel)]="sg.serviceGraphFirewall.firewallDeviceType"
                        (ngModelChange)="onConfigMutated()"
                      >
                        <option>PaloAlto</option>
                        <option>CiscoAsa</option>
                      </select>
                    </div>
                    <div class="form-group col-6">
                      <label>VSYS/Context Name</label>
                      <input
                        class="form-control"
                        [class.is-invalid]="
                          hasFieldError('vrfs.' + selectedVrfIdx + '.serviceGraphs.' + j + '.serviceGraphFirewall.vsysName')
                        "
                        [disabled]="mode === 'edit'"
                        [(ngModel)]="sg.serviceGraphFirewall.vsysName"
                        (ngModelChange)="onConfigMutated()"
                      />
                      <div
                        *ngIf="hasFieldError('vrfs.' + selectedVrfIdx + '.serviceGraphs.' + j + '.serviceGraphFirewall.vsysName')"
                        class="invalid-feedback d-block"
                      >
                        {{ getFieldError('vrfs.' + selectedVrfIdx + '.serviceGraphs.' + j + '.serviceGraphFirewall.vsysName') }}
                      </div>
                    </div>
                  </div>
                  <div class="text-right">
                    <button class="btn btn-sm btn-outline-danger" *ngIf="mode === 'create'" (click)="removeServiceGraph(selectedVrfIdx, j)">
                      Remove
                    </button>
                  </div>
                </div>
              </div>

              <div class="d-flex justify-content-between align-items-center mt-3">
                <h6 class="mb-0">L3Outs</h6>
                <button class="btn btn-sm btn-outline-primary" *ngIf="mode === 'create'" (click)="addL3Out(selectedVrfIdx)">
                  Add L3Out
                </button>
              </div>
              <div class="mt-2" *ngFor="let l3 of config.vrfs[selectedVrfIdx].l3outs; let j = index">
                <div class="border rounded p-2 mb-2" [class.border-danger]="hasL3OutErrors(selectedVrfIdx, j)">
                  <div class="form-row">
                    <div class="form-group col-3">
                      <label>Name</label>
                      <input
                        class="form-control"
                        [class.is-invalid]="hasFieldError('vrfs.' + selectedVrfIdx + '.l3outs.' + j + '.name')"
                        [disabled]="mode === 'edit'"
                        [(ngModel)]="l3.name"
                        (ngModelChange)="onConfigMutated()"
                      />
                      <div *ngIf="hasFieldError('vrfs.' + selectedVrfIdx + '.l3outs.' + j + '.name')" class="invalid-feedback d-block">
                        {{ getFieldError('vrfs.' + selectedVrfIdx + '.l3outs.' + j + '.name') }}
                      </div>
                    </div>
                    <div class="form-group col-3">
                      <label>Type</label>
                      <select
                        class="form-control"
                        [disabled]="mode === 'edit'"
                        [(ngModel)]="l3.l3outType"
                        (ngModelChange)="onConfigMutated()"
                      >
                        <option value="external">external</option>
                        <option value="intervrf">intervrf</option>
                      </select>
                    </div>
                    <div class="form-group col-3" *ngIf="l3.l3outType === 'intervrf'">
                      <label>Propagate External Routes</label>
                      <div class="form-check mt-2">
                        <input
                          type="checkbox"
                          class="form-check-input"
                          [id]="'propagate' + j"
                          [disabled]="mode === 'edit'"
                          [(ngModel)]="l3.propagateExternalRoutes"
                          (ngModelChange)="onConfigMutated()"
                        />
                        <label class="form-check-label" [for]="'propagate' + j">Enable</label>
                      </div>
                    </div>
                    <div class="form-group" [ngClass]="l3.l3outType === 'intervrf' ? 'col-3' : 'col-6'">
                      <label>Firewall</label>
                      <ng-select
                        [ngClass]="{
                          'is-invalid': hasFieldError('vrfs.' + selectedVrfIdx + '.l3outs.' + j + '.externalFirewall')
                        }"
                        [disabled]="mode === 'edit'"
                        [(ngModel)]="l3.externalFirewall"
                        (ngModelChange)="onConfigMutated()"
                        [items]="config.externalFirewalls"
                        bindLabel="name"
                        bindValue="name"
                        placeholder="Select a firewall..."
                        [clearable]="true"
                      >
                      </ng-select>
                      <div
                        *ngIf="hasFieldError('vrfs.' + selectedVrfIdx + '.l3outs.' + j + '.externalFirewall')"
                        class="invalid-feedback d-block"
                      >
                        {{ getFieldError('vrfs.' + selectedVrfIdx + '.l3outs.' + j + '.externalFirewall') }}
                      </div>
                    </div>
                  </div>
                  <div class="text-right">
                    <button class="btn btn-sm btn-outline-danger" *ngIf="mode === 'create'" (click)="removeL3Out(selectedVrfIdx, j)">
                      Remove
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div [class]="leftPanelCollapsed ? 'col-12' : 'col-lg-8 col-md-7'" class="transition-all">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="btn-group btn-group-sm" role="group">
          <button
            type="button"
            class="btn"
            [class.btn-primary]="rightPanelView === 'config'"
            [class.btn-outline-secondary]="rightPanelView !== 'config'"
            (click)="showConfig()"
          >
            Configuration
          </button>
          <button
            type="button"
            class="btn"
            [class.btn-primary]="rightPanelView === 'graph'"
            [class.btn-outline-secondary]="rightPanelView !== 'graph'"
            [disabled]="!graph"
            (click)="showGraph()"
          >
            Graph
          </button>
          <button
            type="button"
            class="btn"
            [class.btn-primary]="rightPanelView === 'response'"
            [class.btn-outline-secondary]="rightPanelView !== 'response'"
            [disabled]="!saveResponse"
            (click)="showResponse()"
          >
            Save Response
          </button>
        </div>
        <div class="btn-group btn-group-sm" role="group" *ngIf="rightPanelView === 'config'">
          <button
            type="button"
            class="btn"
            [class.btn-primary]="previewFormat === 'json'"
            [class.btn-outline-secondary]="previewFormat !== 'json'"
            (click)="previewFormat = 'json'; onFormatChange()"
          >
            JSON
          </button>
          <button
            type="button"
            class="btn"
            [class.btn-primary]="previewFormat === 'yaml'"
            [class.btn-outline-secondary]="previewFormat !== 'yaml'"
            (click)="previewFormat = 'yaml'; onFormatChange()"
          >
            YAML
          </button>
          <button type="button" class="btn btn-outline-secondary" (click)="copyToClipboard()" title="Copy to clipboard">
            Copy to Clipboard
          </button>
        </div>
      </div>

      <!-- Configuration View -->
      <div *ngIf="rightPanelView === 'config'">
        <textarea class="form-control" rows="26" [(ngModel)]="displayConfig" (ngModelChange)="onTextChange()"></textarea>
        <small *ngIf="parseError" class="text-danger">{{ parseError }}</small>

        <h5 class="mt-3">Validation Result</h5>
        <div *ngIf="!validation" class="text-muted">No validation run yet.</div>
        <div *ngIf="validation" class="card">
          <div class="card-body">
            <div>
              <strong>Status:</strong>
              <span [ngClass]="validation.success ? 'text-success' : 'text-danger'">
                {{ validation.success ? 'Valid' : 'Invalid' }}
              </span>
            </div>
            <div class="mt-2" *ngIf="validation.errors?.length">
              <strong>Errors ({{ validation.errors.length }})</strong>
              <ul class="mb-0">
                <li *ngFor="let err of validation.errors">
                  <span class="text-muted">[{{ err.entityName || '-' }}-{{ err.path || '$' }}]</span>
                  <span> {{ err.message }}</span>
                </li>
              </ul>
            </div>
            <div class="mt-2" *ngIf="validation.warnings?.length">
              <strong>Warnings ({{ validation.warnings.length }})</strong>
              <ul class="mb-0">
                <li *ngFor="let warn of validation.warnings">
                  <span class="text-muted">[{{ warn.entityName || '-' }}-{{ warn.path || '$' }}]</span>
                  <span> {{ warn.message }}</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Graph View -->
      <div *ngIf="rightPanelView === 'graph'" style="height: 600px">
        <div *ngIf="graph" id="graphContainer" style="width: 100%; height: 100%; position: relative">
          <svg id="graphSvg" style="width: 100%; height: 100%"></svg>
        </div>
        <div *ngIf="!graph" class="d-flex align-items-center justify-content-center h-100 text-muted">
          <div class="text-center">
            <div class="small">Click "Graph" button in toolbar to generate</div>
          </div>
        </div>
      </div>

      <!-- Save Response View -->
      <div *ngIf="rightPanelView === 'response'" style="height: 600px; overflow-y: auto">
        <div *ngIf="saveResponse" class="card">
          <div class="card-header">
            <h6 class="mb-0">Save Response</h6>
          </div>
          <div class="card-body">
            <pre class="bg-light p-3" style="font-size: 12px">{{ saveResponse | json }}</pre>
          </div>
        </div>
        <div *ngIf="!saveResponse" class="d-flex align-items-center justify-content-center h-100 text-muted">
          No save response available
        </div>
      </div>
    </div>
  </div>

  <!-- Yes/No Modal -->
  <app-yes-no-modal></app-yes-no-modal>
</section>
