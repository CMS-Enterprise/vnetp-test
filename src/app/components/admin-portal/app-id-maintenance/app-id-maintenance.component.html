<div class="container">
  <h2>App ID Version Maintenance</h2>

  <div class="table-container">
    <table mat-table [dataSource]="dataSource" multiTemplateDataRows class="mat-elevation-z8">
      <!-- Tenant Checkbox Column -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox
            (change)="$event ? toggleAllTenants() : null"
            [checked]="tenantSelection.hasValue() && isAllTenantsSelected()"
            [indeterminate]="tenantSelection.hasValue() && !isAllTenantsSelected()"
          >
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let tenant">
          <mat-checkbox
            (click)="$event.stopPropagation()"
            (change)="$event ? tenantSelection.toggle(tenant) : null"
            [checked]="tenantSelection.isSelected(tenant)"
          >
          </mat-checkbox>
        </td>
      </ng-container>

      <!-- Tenant Name Column -->
      <ng-container matColumnDef="tenantName">
        <th mat-header-cell *matHeaderCellDef>Tenant Name</th>
        <td mat-cell *matCellDef="let tenant">{{ tenant.tenantName }}</td>
      </ng-container>

      <!-- Expand Column -->
      <ng-container matColumnDef="expand">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let tenant">
          <button mat-icon-button (click)="toggleTenant(tenant)">
            <fa-icon [icon]="tenant.expanded ? faChevronUp : faChevronDown"></fa-icon>
          </button>
        </td>
      </ng-container>

      <!-- Expanded Detail Column -->
      <ng-container matColumnDef="expandedDetail">
        <td mat-cell *matCellDef="let tenant" [attr.colspan]="displayedColumns.length">
          <div class="tier-detail-content">
            <table mat-table [dataSource]="tenant.tiers" class="tier-table">
              <!-- Tier Checkbox Column -->
              <ng-container matColumnDef="select">
                <th mat-header-cell *matHeaderCellDef>
                  <mat-checkbox (change)="$event ? toggleAllTiers(tenant) : null" [checked]="isAllTiersSelected(tenant)"> </mat-checkbox>
                </th>
                <td mat-cell *matCellDef="let tier">
                  <mat-checkbox
                    (click)="$event.stopPropagation()"
                    (change)="$event ? tierSelection.toggle(tier) : null"
                    [checked]="tierSelection.isSelected(tier)"
                  >
                  </mat-checkbox>
                </td>
              </ng-container>

              <!-- Tier Name Column -->
              <ng-container matColumnDef="tierName">
                <th mat-header-cell *matHeaderCellDef>Tier Name</th>
                <td mat-cell *matCellDef="let tier">{{ tier.tierName }}</td>
              </ng-container>

              <!-- Current Version Column -->
              <ng-container matColumnDef="currentVersion">
                <th mat-header-cell *matHeaderCellDef>Current Version</th>
                <td mat-cell *matCellDef="let tier">{{ tier.currentVersion }}</td>
              </ng-container>

              <!-- Last Updated Column -->
              <ng-container matColumnDef="lastUpdated">
                <th mat-header-cell *matHeaderCellDef>Last Updated</th>
                <td mat-cell *matCellDef="let tier">{{ tier.lastUpdated }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="tierColumns"></tr>
              <tr mat-row *matRowDef="let tier; columns: tierColumns"></tr>
            </table>
          </div>
        </td>
      </ng-container>

      <!-- Tenant Row -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let tenant; columns: displayedColumns" class="tenant-row"></tr>
      <tr mat-row *matRowDef="let tenant; columns: ['expandedDetail']; when: isExpansionDetailRow" class="tier-detail-row"></tr>
    </table>
  </div>

  <div class="update-section">
    <h3>Update Selected Tiers</h3>
    <p>To update the selected tiers, please visit the following site to obtain an update code:</p>
    <a [href]="externalSiteUrl" target="_blank" class="external-link">{{ externalSiteUrl }}</a>

    <form class="update-form">
      <mat-form-field appearance="outline">
        <mat-label>Update Code</mat-label>
        <input matInput [(ngModel)]="updateCode" name="updateCode" placeholder="Enter update code" />
      </mat-form-field>

      <button
        mat-raised-button
        color="primary"
        [disabled]="!updateCode || (tierSelection.selected.length === 0 && tenantSelection.selected.length === 0)"
      >
        Update Selected Tiers
      </button>
    </form>
  </div>
</div>
