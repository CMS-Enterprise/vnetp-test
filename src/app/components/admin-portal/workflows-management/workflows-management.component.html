<section class="workflows-wrapper">
  <header class="section-header">
    <div>
      <p class="eyebrow">Admin Portal</p>
      <h1>Workflow Management</h1>
    </div>
  </header>

  <nav class="task-switcher" aria-label="Workflow actions">
    <button type="button" [class.active]="activeTask === 'view'" (click)="setTask('view')">View All Workflows</button>
    <button type="button" [class.active]="activeTask === 'approve'" (click)="setTask('approve')">
      Approve Workflows
      <span *ngIf="totalPendingApprovals > 0" class="badge">{{ totalPendingApprovals }}</span>
    </button>
    <button type="button" [class.active]="activeTask === 'launch'" (click)="setTask('launch')">Launch Workflow</button>
  </nav>

  <div *ngIf="isLoading" class="loading-state">Loading workflow data…</div>
  <div *ngIf="loadingError" class="error-state">{{ loadingError }}</div>

  <!-- View All Workflows -->
  <section *ngIf="activeTask === 'view' && !isLoading" class="task-panel">
    <h2>Workflows by Tenant</h2>
    <p *ngIf="tenantAccounts.length === 0" class="empty-state">No workflows found.</p>
    <ng-container *ngFor="let account of tenantAccounts; trackBy: trackByAccount">
      <h3 class="tenant-account-title">{{ account.accountDisplayName }}</h3>
      <ng-container *ngIf="account.tenants?.length > 0; else emptyAccount">
        <div *ngFor="let tenant of account.tenants; trackBy: trackByTenant" class="tenant-card">
          <button type="button" class="tenant-summary" (click)="toggleTenant('view', tenant.tenantId)">
            <div>
              <p class="tenant-name">{{ tenant.tenantName }}</p>
              <p class="tenant-env">{{ tenant.environment }}</p>
            </div>
            <div class="tenant-metrics" *ngIf="getWorkflowTotals(tenant) as totals">
              <div>
                <span class="label">Total</span>
                <span class="value">{{ totals.total }}</span>
              </div>
              <div>
                <span class="label">Pending</span>
                <span class="value">{{ totals.pending }}</span>
              </div>
              <div>
                <span class="label">Running</span>
                <span class="value">{{ totals.running }}</span>
              </div>
              <div>
                <span class="label">Completed</span>
                <span class="value">{{ totals.completed }}</span>
              </div>
              <div>
                <span class="label">Failed</span>
                <span class="value">{{ totals.failed }}</span>
              </div>
            </div>
            <span class="chevron" [class.expanded]="isTenantExpanded('view', tenant.tenantId)"></span>
          </button>

          <div *ngIf="isTenantExpanded('view', tenant.tenantId)" class="tenant-details">
            <ng-container *ngIf="viewTableConfig">
              <app-table
                [config]="getViewTableConfig(tenant.tenantId)"
                [data]="getTenantTableData(tenant, 'view')"
                [itemsPerPage]="getTenantTableState(tenant.tenantId, 'view').perPage"
                (tableEvent)="onTenantTableEvent(tenant.tenantId, 'view', $event)"
                [searchColumns]="[]"
              ></app-table>
            </ng-container>
          </div>
        </div>
      </ng-container>
    </ng-container>
    <ng-template #emptyAccount>
      <p class="empty-state">No tenants found for this tenant account.</p>
    </ng-template>
  </section>

  <!-- Approve Workflows -->
  <section *ngIf="activeTask === 'approve' && !isLoading" class="task-panel">
    <h2>Pending Approvals</h2>
    <p *ngIf="totalPendingApprovals === 0" class="empty-state">No workflows are waiting for approval.</p>

    <ng-container *ngFor="let account of accountsWithPendingApprovals; trackBy: trackByAccount">
      <h3 class="tenant-account-title">{{ account.accountDisplayName }}</h3>
      <div *ngFor="let tenant of account.tenants; trackBy: trackByTenant" class="tenant-card">
        <button type="button" class="tenant-summary" (click)="toggleTenant('approve', tenant.tenantId)">
          <div>
            <p class="tenant-name">{{ tenant.tenantName }}</p>
            <p class="tenant-env">{{ tenant.environment }}</p>
          </div>
          <div class="tenant-metrics">
            <div>
              <span class="label">Pending</span>
              <span class="value">{{ getPendingApprovals(tenant).length }}</span>
            </div>
          </div>
          <span class="chevron" [class.expanded]="isTenantExpanded('approve', tenant.tenantId)"></span>
        </button>

        <div *ngIf="isTenantExpanded('approve', tenant.tenantId)" class="tenant-details">
          <div class="tenant-actions">
            <button type="button" class="btn btn-primary btn-sm" (click)="approveAllForTenant(tenant.tenantId)">Approve All</button>
          </div>
          <ng-container *ngIf="approveTableConfig">
            <app-table
              [config]="getApproveTableConfig(tenant.tenantId)"
              [data]="getTenantTableData(tenant, 'approve')"
              [itemsPerPage]="getTenantTableState(tenant.tenantId, 'approve').perPage"
              (tableEvent)="onTenantTableEvent(tenant.tenantId, 'approve', $event)"
              [searchColumns]="[]"
            ></app-table>
          </ng-container>
        </div>
      </div>
    </ng-container>
  </section>

  <!-- Launch Workflow -->
  <section *ngIf="activeTask === 'launch'" class="task-panel">
    <h2>Launch a Workflow</h2>
    <p class="lead">Create a workflow using the live API. Requests will appear in the tenant tables above.</p>
    <form [formGroup]="launchForm" (ngSubmit)="onLaunchWorkflow()" novalidate>
      <div class="launch-mode-toggle" role="radiogroup" aria-label="Launch mode">
        <button
          type="button"
          role="radio"
          [attr.aria-checked]="!isGroupLaunchMode()"
          class="mode-pill"
          [class.active]="!isGroupLaunchMode()"
          (click)="setLaunchMode('module')"
        >
          <span class="title">Individual Module</span>
          <span class="subtitle">Run a single Terraform module</span>
        </button>
        <button
          type="button"
          role="radio"
          [attr.aria-checked]="isGroupLaunchMode()"
          class="mode-pill"
          [class.active]="isGroupLaunchMode()"
          (click)="setLaunchMode('group')"
        >
          <span class="title">Group Launch</span>
          <span class="subtitle">Trigger multiple modules together</span>
        </button>
      </div>

      <div class="form-grid">
        <label>
          <span>Tenant</span>
          <select formControlName="tenantId">
            <option value="" disabled>Select a tenant</option>
            <option *ngFor="let option of tenantOptions" [value]="option.tenantId">
              {{ option.tenantName }} · {{ option.accountDisplayName }}
            </option>
          </select>
          <small *ngIf="launchForm.get('tenantId').touched && launchForm.get('tenantId').invalid">Required.</small>
        </label>

        <label *ngIf="!isGroupLaunchMode()">
          <span>Module</span>
          <select formControlName="moduleType">
            <option value="" disabled>Select a module</option>
            <option *ngFor="let type of workflowTypeOptions" [value]="type">{{ formatLabel(type) }}</option>
          </select>
          <small *ngIf="launchForm.get('moduleType').touched && launchForm.get('moduleType').invalid">Required.</small>
        </label>

        <label *ngIf="isGroupLaunchMode()">
          <span>Group</span>
          <select formControlName="groupType">
            <option *ngFor="let option of groupLaunchOptions" [value]="option.id">
              {{ option.label }}
            </option>
          </select>
        </label>
      </div>

      <div *ngIf="isGroupLaunchMode()" class="group-details-card">
        <p class="group-description">{{ selectedGroupOption?.description }}</p>
        <p class="group-subtitle">Modules that will be launched:</p>
        <ul>
          <li *ngFor="let module of selectedGroupOption?.modules">{{ formatLabel(module) }}</li>
        </ul>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary" [disabled]="launchForm.invalid || isLaunching">
          <span *ngIf="!isLaunching">Launch Workflow</span>
          <span *ngIf="isLaunching">Launching…</span>
        </button>
      </div>

      <p *ngIf="launchSuccessMessage" class="success-message">
        {{ launchSuccessMessage }}
      </p>
      <p *ngIf="launchErrorMessage" class="error-state">
        {{ launchErrorMessage }}
      </p>
    </form>
  </section>
</section>

<ng-template #workflowStatusTemplate let-datum="datum">
  <span
    class="status-chip"
    [class.pending]="approvalRequiredStatuses.has(datum.status)"
    [class.queued]="pendingStatuses.has(datum.status)"
    [class.failed]="failedStatuses.has(datum.status)"
    [class.completed]="completedStatuses.has(datum.status)"
    [class.running]="!approvalRequiredStatuses.has(datum.status) && !failedStatuses.has(datum.status) && runningStatuses.has(datum.status)"
  >
    {{ formatStatus(datum.status) }}
  </span>
</ng-template>

<ng-template #approveActionsTemplate let-datum="datum">
  <div class="actions-cell">
    <button type="button" class="btn btn-link btn-sm" (click)="openWorkflowDetails(datum)">View</button>
    <button
      type="button"
      class="btn btn-outline-success btn-sm"
      [disabled]="isApproving(datum.id)"
      (click)="approveWorkflow(datum.tenantId, datum.id)"
    >
      <span *ngIf="!isApproving(datum.id)">Approve</span>
      <span *ngIf="isApproving(datum.id)">Approving…</span>
    </button>
  </div>
</ng-template>

<ng-template #workflowActionsTemplate let-datum="datum">
  <div class="actions-cell">
    <button type="button" class="btn btn-link btn-sm" (click)="openWorkflowDetails(datum)">View</button>
  </div>
</ng-template>

<app-workflow-view-modal></app-workflow-view-modal>
