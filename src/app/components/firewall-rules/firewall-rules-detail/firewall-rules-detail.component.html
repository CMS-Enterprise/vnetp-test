<a
  routerLink="/netcentric/firewall-rules"
  queryParamsHandling="merge"
  class="btn btn-info"
  *ngIf="applicationMode === ApplicationMode.NETCENTRIC"
>
  <fa-icon class="icon" [icon]="['fas', 'chevron-left']"></fa-icon>
  <span>Back</span>
</a>

<h1 *ngIf="applicationMode === ApplicationMode.NETCENTRIC">{{ TierName }} - {{ FirewallRuleGroup?.name }} FW Rules</h1>

<section class="btn-toolbar" role="toolbar">
  <!-- Add Firewall Rule -->
  <button type="button" class="btn btn-success" (click)="createFirewallRule()">
    <fa-icon class="icon" [icon]="['fas', 'plus']"></fa-icon>
    <span>Add Firewall Rule</span>
  </button>

  <!-- Refresh -->
  <button type="button" class="btn btn-info" (click)="refresh()">
    <fa-icon class="icon" [icon]="['fas', 'sync-alt']"></fa-icon>
    <span>Refresh</span>
  </button>

  <button
    class="btn btn-info"
    *ngIf="FirewallRuleGroup?.type === 'Intervrf' || FirewallRuleGroup?.type === 'External'"
    (click)="openPacketTracer()"
  >
    Packet Tracer
  </button>
</section>

<ng-container *ngIf="!isLoading; else loading">
  <app-table
    [config]="config"
    [data]="firewallRules"
    (clearResults)="getFirewallRules($event)"
    (searchParams)="getFirewallRules($event)"
    [searchColumns]="searchColumns"
    [(itemsPerPage)]="perPage"
    (tableEvent)="onTableEvent($event)"
  ></app-table>
</ng-container>

<ng-template #actionsTemplate let-firewallRule="datum">
  <section class="table__actions">
    <app-icon-button
      *ngIf="checkUndeployedChanges(firewallRule)"
      icon="asterisk"
      label="Undeployed Changes"
      [type]="'info'"
    ></app-icon-button>

    <app-icon-button
      *ngIf="!firewallRule?.deletedAt && FirewallRuleGroup?.type !== 'ZoneBased'"
      icon="clone"
      label="Move/Clone Firewall Rule"
      (handleClick)="openFirewallRuleOperationModal(firewallRule)"
    ></app-icon-button>

    <app-icon-button
      *ngIf="!firewallRule?.deletedAt"
      icon="edit"
      label="Edit Firewall Rule"
      (handleClick)="openFirewallRuleModal(ModalMode.Edit, firewallRule)"
    ></app-icon-button>

    <app-icon-button
      *ngIf="firewallRule?.deletedAt"
      icon="undo"
      label="Restore Firewall Rule"
      type="success"
      (handleClick)="restoreFirewallRule(firewallRule)"
    ></app-icon-button>

    <app-icon-button
      icon="delete"
      label="Soft-Delete/Delete Firewall Rule"
      [type]="firewallRule.deletedAt ? 'danger' : 'default'"
      (handleClick)="deleteFirewallRule(firewallRule)"
    >
    </app-icon-button>
  </section>
</ng-template>

<ng-template #loading>
  <fa-icon class="icon" [icon]="['fas', 'spinner']" [spin]="true"></fa-icon>
</ng-template>

<section class="btn-toolbar" role="toolbar">
  <app-import-export
    *ngIf="applicationMode === ApplicationMode.NETCENTRIC"
    [exportObject]="firewallRules"
    exportFileName="firewallRules-{{ TierName }}-{{ FirewallRuleGroup?.name }}"
    (import)="importFirewallRulesConfig($event)"
    [disableJson]="false"
  ></app-import-export>
</section>

<app-firewall-rule-modal></app-firewall-rule-modal>
<app-yes-no-modal></app-yes-no-modal>
<app-preview-modal></app-preview-modal>

<app-firewall-rule-object-info-modal></app-firewall-rule-object-info-modal>

<!-- source address template -->
<ng-template #sourceAddress let-firewallRule="datum">
  <p *ngIf="firewallRule.sourceAddressType === 'IpAddress'" aria-label="Source IP">
    {{ firewallRule?.sourceIpAddress }}
  </p>
  <p
    (click)="getObjectInfo('Source NetworkObject', firewallRule.sourceAddressType, firewallRule.sourceNetworkObjectId)"
    style="color: blue; cursor: pointer"
    *ngIf="firewallRule.sourceAddressType === 'NetworkObject'"
    aria-label="Source Network Object"
  >
    {{ firewallRule?.sourceNetworkObjectId | resolve : getNetworkObjectName }}
    (Object)
  </p>
  <p
    (click)="getObjectInfo('Source NetworkObjectGroup', firewallRule.sourceAddressType, firewallRule.sourceNetworkObjectGroupId)"
    style="color: blue; cursor: pointer"
    *ngIf="firewallRule.sourceAddressType === 'NetworkObjectGroup'"
    aria-label="Source Network Object Group"
  >
    {{ firewallRule?.sourceNetworkObjectGroupId | resolve : getNetworkObjectGroupName }}
    (Object Group)
  </p>
  <p *ngIf="firewallRule.sourceAddressType === 'EndpointGroup'" aria-label="Source Endpoint Group">
    {{ firewallRule?.sourceEndpointGroupId | resolve : getEndpointGroupName }}
    (Endpoint Group)
  </p>
  <p *ngIf="firewallRule.sourceAddressType === 'EndpointSecurityGroup'" aria-label="Source Endpoint Security Group">
    {{ firewallRule?.sourceEndpointSecurityGroupId | resolve : getEndpointSecurityGroupName }}
  </p>
</ng-template>

<!-- destination address template -->
<ng-template #destinationAddress let-firewallRule="datum">
  <p *ngIf="firewallRule.destinationAddressType === 'IpAddress'" aria-label="Destination IP">
    {{ firewallRule?.destinationIpAddress }}
  </p>
  <p
    (click)="getObjectInfo('Destination NetworkObject', firewallRule.destinationAddressType, firewallRule.destinationNetworkObjectId)"
    style="color: blue; cursor: pointer"
    *ngIf="firewallRule.destinationAddressType === 'NetworkObject'"
    aria-label="Destination Network Object"
  >
    {{ firewallRule?.destinationNetworkObjectId | resolve : getNetworkObjectName }}
    (Object)
  </p>
  <p
    (click)="
      getObjectInfo('Destination NetworkObjectGroup', firewallRule.destinationAddressType, firewallRule.destinationNetworkObjectGroupId)
    "
    style="color: blue; cursor: pointer"
    *ngIf="firewallRule.destinationAddressType === 'NetworkObjectGroup'"
    aria-label="Destination Network Object Group"
  >
    {{ firewallRule?.destinationNetworkObjectGroupId | resolve : getNetworkObjectGroupName }}
    (Object Group)
  </p>

  <p *ngIf="firewallRule.destinationAddressType === 'EndpointGroup'" aria-label="Destination Endpoint Group">
    {{ firewallRule?.destinationEndpointGroupId | resolve : getEndpointGroupName }}
    (Endpoint Group)
  </p>
  <p *ngIf="firewallRule.destinationAddressType === 'EndpointSecurityGroup'" aria-label="Destination Endpoint Security Group">
    {{ firewallRule?.destinationEndpointSecurityGroupId | resolve : getEndpointSecurityGroupName }}
  </p>
</ng-template>

<!-- service type template -->
<ng-template #serviceType let-firewallRule="datum">
  <p *ngIf="firewallRule.serviceType === 'Port'" aria-label="Source/Destination Ports">
    Source Ports: {{ firewallRule?.sourcePorts }} - Destination Ports: {{ firewallRule?.destinationPorts }}
  </p>
  <p
    (click)="getObjectInfo('Service Object', firewallRule.serviceType, firewallRule.serviceObjectId)"
    style="color: blue; cursor: pointer"
    *ngIf="firewallRule.serviceType === 'ServiceObject'"
    aria-label="Service Object"
  >
    {{ firewallRule?.serviceObjectId | resolve : getServiceObjectName }} (Object)
  </p>
  <p
    (click)="getObjectInfo('Service Object Group', firewallRule.serviceType, firewallRule.serviceObjectGroupId)"
    style="color: blue; cursor: pointer"
    *ngIf="firewallRule.serviceType === 'ServiceObjectGroup'"
    aria-label="Service Object Group"
  >
    {{ firewallRule?.serviceObjectGroupId | resolve : getServiceObjectGroupName }} (Object Group)
  </p>
</ng-template>

<!-- to/from zone/direction template -->
<ng-template #directionZone let-firewallRule="datum">
  <p *ngIf="FirewallRuleGroup?.type === 'Intervrf' || FirewallRuleGroup?.type === 'External'" aria-label="Direction">
    {{ firewallRule?.direction }}
  </p>
  <p *ngIf="FirewallRuleGroup?.type === 'ZoneBased'" aria-label="From Zone">From: {{ getZoneNames(firewallRule.fromZone) }}</p>
  <p *ngIf="FirewallRuleGroup?.type === 'ZoneBased'" aria-label="To Zone">To: {{ getZoneNames(firewallRule.toZone) }}</p>
</ng-template>

<app-firewall-rule-packet-tracer [objects]="packetTracerObjects"></app-firewall-rule-packet-tracer>

<app-firewall-rules-operation-modal
  (emitGetRuleGroup)="getFirewallRuleGroup()"
  [networkObjects]="networkObjects"
  [networkObjectGroups]="networkObjectGroups"
  [serviceObjects]="serviceObjects"
  [serviceObjectGroups]="serviceObjectGroups"
></app-firewall-rules-operation-modal>

<ng-template #expandableRowsTemplate let-firewallRule="datum">
  <div class="hitcount-container">
    <div class="hitcount-display">
      <strong>Hit Count:&nbsp;</strong>
      <span>{{ firewallRule.hitCount === null ? '-' : firewallRule.hitCount }}</span>
    </div>

    <div class="last-refreshed">
      <strong>Last Refreshed:&nbsp;</strong>
      <span>
        {{ FirewallRuleGroup.runtimeDataLastRefreshed ? calculateTimeDifference(FirewallRuleGroup.runtimeDataLastRefreshed) : '-' }}
      </span>
    </div>

    <button
      (click)="refreshHitcount()"
      class="refresh-button"
      [ngClass]="{ 'green-button': isRecentlyRefreshed() }"
      [disabled]="isRefreshingRuntimeData || isRecentlyRefreshed()"
    >
      <ng-container *ngIf="!isRefreshingRuntimeData && !isRecentlyRefreshed()">Refresh Hitcount</ng-container>
      <ng-container *ngIf="isRefreshingRuntimeData">
        <fa-icon class="icon" [icon]="['fas', 'spinner']" [spin]="true"></fa-icon>
        Refreshing...
      </ng-container>
      <ng-container *ngIf="isRecentlyRefreshed() && !isRefreshingRuntimeData">Refreshed</ng-container>
    </button>
  </div>
</ng-template>
