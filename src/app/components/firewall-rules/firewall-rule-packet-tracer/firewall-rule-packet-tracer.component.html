<ngx-smart-modal
  #firewallRulePacketTracer
  identifier="firewallRulePacketTracer"
  (onClose)="reset()"
  (onOpen)="onOpen()"
  [dismissable]="false"
  customClass="xxlarge-modal"
>
  <mat-drawer-container style="position: absolute; top: 0; bottom: 0; right: 0; left: 0">
    <mat-drawer-content>
      <div class="toolbar">
        <div class="search-container">
          <!-- Search Bar -->
          <div class="search-bar" [class.active]="isSearchOpen">
            <input
              *ngIf="isSearchOpen"
              #searchInput
              type="text"
              [(ngModel)]="searchQuery"
              (ngModelChange)="applyFilter()"
              placeholder="Type to search name"
              (blur)="toggleSearch()"
            />
          </div>

          <!-- Search Icon -->
          <app-icon-button
            class="search-icon"
            [icon]="isSearchOpen ? 'times' : 'search'"
            [label]="isSearchOpen ? 'Close Search' : 'Search'"
            [type]="isSearchOpen ? 'times' : 'search'"
            (click)="toggleSearch()"
          ></app-icon-button>
        </div>

        <mat-menu yPosition="above" #filterMenu="matMenu">
          <mat-radio-group [(ngModel)]="filterExact" (change)="applyFilter()" style="display: flex; flex-direction: column; gap: 1px">
            <mat-radio-button (click)="$event.stopPropagation()" [value]="null">All Match</mat-radio-button>
            <mat-radio-button (click)="$event.stopPropagation()" [value]="true">Exact Match</mat-radio-button>
            <mat-radio-button (click)="$event.stopPropagation()" [value]="false">Partial Match</mat-radio-button>
          </mat-radio-group>
        </mat-menu>
        <button type="button" [matMenuTriggerFor]="filterMenu" class="btn btn-icon" title="filter" attr.aria-label="filter">
          <fa-icon className="filter" [icon]="['fas', 'filter']"></fa-icon>
        </button>
        <app-icon-button icon="undo" label="clear form" type="undo" (handleClick)="resetForm()"></app-icon-button>
        <app-icon-button icon="times" label="close" type="times" (handleClick)="close()"></app-icon-button>
      </div>

      <div class="table-container">
        <table style="box-shadow: none; margin: 0" mat-table [dataSource]="firewallRulesArray" class="mat-elevation-z8">
          <ng-container *ngFor="let col of tableConfig.displayedColumns" [matColumnDef]="col">
            <th
              mat-header-cell
              *matHeaderCellDef
              [style.backgroundColor]="hoveredColumn === col ? '#bbdefb' : null"
              [style.textAlign]="'center'"
            >
              {{ tableConfig.columnLabels[col] }}
            </th>
            <td
              mat-cell
              *matCellDef="let firewallrule"
              [style.backgroundColor]="hoveredRow?.name === firewallrule?.name || hoveredColumn === col ? '#e3f2fd' : null"
              [style.textAlign]="'center'"
            >
              <ng-container *ngIf="col === 'name'; else dynamicCell">
                {{ firewallrule.name }}
              </ng-container>
              <ng-template #dynamicCell>
                <span *ngIf="isChecklistFieldEmpty(col, firewallrule); else matched"></span>
                <ng-template #matched>
                  <span *ngIf="firewallrule.checkList[col]; else notMatched">&#10003;</span>
                </ng-template>
                <ng-template #notMatched>
                  <span>&#10007;</span>
                </ng-template>
              </ng-template>
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="tableConfig.displayedColumns"></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: tableConfig.displayedColumns"
            [class.highlight-row]="hoveredRow?.name === row?.name"
          ></tr>
        </table>
      </div>
      <span *ngIf="!firewallRulesArray.length" class="empty-message">No Data</span>
    </mat-drawer-content>
    <mat-drawer [opened]="isDrawerOpened" mode="side" position="start">
      <div class="drawer-content">
        <h3>Packet Tracer</h3>
        <button type="submit" (click)="search()">Search</button>
        <form [formGroup]="form" class="form-container">
          <div>
            <mat-label>Action</mat-label>
            <mat-radio-group formControlName="action" name="action" style="display: flex; flex-direction: column; gap: 1px">
              <mat-radio-button value="Deny">Deny</mat-radio-button>
              <mat-radio-button value="Permit">Permit</mat-radio-button>
            </mat-radio-group>
          </div>

          <div>
            <mat-label>Direction</mat-label>
            <mat-radio-group formControlName="direction" name="direction" style="display: flex; flex-direction: column; gap: 1px">
              <mat-radio-button value="In">In</mat-radio-button>
              <mat-radio-button value="Out">Out</mat-radio-button>
            </mat-radio-group>
          </div>

          <div class="mb-2">
            <mat-label>Enabled</mat-label>
            <mat-radio-group formControlName="enabled" name="enabled" style="display: flex; flex-direction: column; gap: 1px">
              <mat-radio-button [value]="true">True</mat-radio-button>
              <mat-radio-button [value]="false">False</mat-radio-button>
            </mat-radio-group>
          </div>

          <mat-form-field appearance="outline">
            <mat-label>Protocol</mat-label>
            <mat-select formControlName="protocol" name="protocol">
              <mat-option *ngFor="let option of protocols" [value]="option">{{ option }}</mat-option>
            </mat-select>
          </mat-form-field>

          <div>
            <mat-form-field appearance="outline">
              <mat-label>Source IP</mat-label>
              <input formControlName="sourceInRange" matInput type="text" placeholder="Enter source IP" name="sourceInRange" />
              <mat-error *ngIf="f.sourceInRange.errors?.required">Source IP Address is required</mat-error>
              <mat-error *ngIf="f.sourceInRange.errors?.invalidIp">Must be a valid IPv4</mat-error>
            </mat-form-field>
          </div>

          <div>
            <mat-form-field appearance="outline">
              <mat-label>Destination IP</mat-label>
              <input formControlName="destInRange" matInput type="text" placeholder="Enter destination IP" name="destInRange" />
              <mat-error *ngIf="f.destInRange.errors?.required">Dest IP Address is required</mat-error>
              <mat-error *ngIf="f.destInRange.errors?.invalidIp">Must be a valid IPv4</mat-error>
            </mat-form-field>
          </div>
          <!-- 
          <mat-form-field appearance="fill">
            <mat-label>Application</mat-label>
            <mat-select formControlName="application" name="application">
              <mat-option value="">Select application</mat-option>
            </mat-select>
          </mat-form-field> -->

          <div>
            <mat-form-field appearance="outline">
              <mat-label>Source Port</mat-label>
              <input formControlName="sourcePort" matInput type="text" placeholder="Enter source port" name="sourcePort" />
              <mat-error *ngIf="f.sourcePort.errors?.required">Source Port is required</mat-error>
              <mat-error *ngIf="f.sourcePort.errors?.invalidPortNumber">Source Port must be between 1-65535</mat-error>
              <mat-error *ngIf="f.sourcePort.errors?.portRangeNotAllowed">Port range not allowed</mat-error>
            </mat-form-field>
          </div>

          <div>
            <mat-form-field appearance="outline">
              <mat-label>Destination Port</mat-label>
              <input formControlName="destPort" matInput type="text" placeholder="Enter destination port" name="destinationPort" />
              <mat-error *ngIf="f.destPort.errors?.required">Destination Port is required</mat-error>
              <mat-error *ngIf="f.destPort.errors?.invalidPortNumber">Destination Port must be between 1-65535</mat-error>
              <mat-error *ngIf="f.destPort.errors?.portRangeNotAllowed">Port range not allowed</mat-error>
            </mat-form-field>
          </div>
        </form>
      </div>
    </mat-drawer>
  </mat-drawer-container>
</ngx-smart-modal>
