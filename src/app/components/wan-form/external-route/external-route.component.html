<ng-template #refreshButtonTemplate>
  <button
    (click)="refreshRuntimeData()"
    class="btn"
    [ngClass]="{ 'btn-success': isRecentlyRefreshed(), 'btn-secondary': !isRecentlyRefreshed() }"
    [disabled]="isRefreshingRuntimeData || isRecentlyRefreshed()"
  >
    <ng-container *ngIf="!isRefreshingRuntimeData && !isRecentlyRefreshed()">Refresh</ng-container>
    <ng-container *ngIf="isRefreshingRuntimeData">
      <fa-icon class="icon" [icon]="['fas', 'spinner']" [spin]="true"></fa-icon>
      Refreshing...
    </ng-container>
    <ng-container *ngIf="isRecentlyRefreshed() && !isRefreshingRuntimeData">Refreshed</ng-container>
  </button>
</ng-template>

<h1>Manage Allowed External Routes for: {{ wanForm?.name }}</h1>

<div>
  <section class="btn-toolbar" role="toolbar" aria-label="create-external-route">
    <button class="btn btn-primary" (click)="openModal()">
      <fa-icon class="icon" [icon]="['fas', 'plus']"></fa-icon>
      <span>Create External Route</span>
    </button>
    <ng-container *ngTemplateOutlet="refreshButtonTemplate"></ng-container>
  </section>

  <mat-tab-group>
    <mat-tab label="Assigned Routes">
      <input
        type="text"
        class="search-input ml-1 mb-1 mt-3"
        placeholder="Search..."
        aria-label="Search"
        [(ngModel)]="assignedRoutesSearchQuery"
        (keyup)="onAssignedRoutesSearch()"
      />
      <div class="table-responsive">
        <table class="table table-striped" matSort #assignedRoutesSort="matSort">
          <thead>
            <tr>
              <th mat-sort-header="network">Network</th>
              <th mat-sort-header="externalVrf">External VRF</th>
              <th mat-sort-header="lastSeen">Last Seen</th>
              <th mat-sort-header="protocol">Protocol</th>
              <th mat-sort-header="metric">Metric</th>
              <th mat-sort-header="uptime">Uptime</th>
              <th mat-sort-header="tag">Tag</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngIf="(assignedRoutesDataSource.filteredData || assignedRoutesDataSource.data).length > 0; else noData">
              <tr
                *ngFor="let route of assignedRoutesDataSource.filteredData || assignedRoutesDataSource.data"
                [class.associated]="route.isAssociated"
              >
                <td>{{ route.network }}</td>
                <td>{{ route.globalExternalRoute.externalVrf }}</td>
                <td>
                  {{ route.lastSeen }}
                  <mat-icon matTooltip="Expired" aria-label="Expired route icon" *ngIf="route.expired">event_busy</mat-icon>
                </td>
                <td>{{ route.protocol }}</td>
                <td>{{ route.metric }}</td>
                <td>{{ route.uptime || '-' }}</td>
                <td>{{ route.tag }}</td>
                <td>
                  <!-- Actions for active (not soft-deleted) routes -->
                  <ng-container *ngIf="!route.deletedAt">
                    <button mat-icon-button matTooltip="Remove Route from Wan Form" (click)="removeRouteFromWanForm(route)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </ng-container>

                  <!-- Actions for soft-deleted routes -->
                  <ng-container *ngIf="route.deletedAt">
                    <button mat-icon-button matTooltip="Restore Route" color="primary" (click)="restoreRoute(route)">
                      <mat-icon>undo</mat-icon>
                    </button>
                    <button mat-icon-button matTooltip="Permanently Delete Route" color="warn" (click)="removeRouteFromWanForm(route)">
                      <mat-icon>delete_forever</mat-icon>
                    </button>
                  </ng-container>
                </td>
              </tr>
            </ng-container>
            <ng-template #noData>
              <tr>
                <td colspan="7" class="text-center">No routes available</td>
              </tr>
            </ng-template>
          </tbody>
        </table>
      </div>
    </mat-tab>
    <mat-tab label="Available Routes">
      <input
        type="text"
        class="search-input ml-1 mb-1 mt-3"
        placeholder="Search..."
        aria-label="Search"
        [(ngModel)]="availableRoutesSearchQuery"
        (keyup)="onAvailableRoutesSearch()"
      />
      <div class="table-responsive">
        <table class="table table-striped" matSort #availableRoutesSort="matSort">
          <thead>
            <tr>
              <th mat-sort-header="network">Network</th>
              <th mat-sort-header="externalVrf">External VRF</th>
              <th mat-sort-header="lastSeen">Last Seen</th>
              <th mat-sort-header="protocol">Protocol</th>
              <th mat-sort-header="metric">Metric</th>
              <th mat-sort-header="uptime">Uptime</th>
              <th mat-sort-header="tag">Tag</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngIf="(availableRoutesDataSource.filteredData || availableRoutesDataSource.data).length > 0; else noData">
              <tr
                *ngFor="let route of availableRoutesDataSource.filteredData || availableRoutesDataSource.data"
                [class.associated]="route.isAssociated"
              >
                <td>{{ route.network }}</td>
                <td>{{ route.externalVrf }}</td>
                <td>
                  {{ route.lastSeen }}
                  <mat-icon matTooltip="Expired" aria-label="Expired route icon" *ngIf="route.expired">event_busy</mat-icon>
                </td>
                <td>{{ route.protocol }}</td>
                <td>{{ route.metric }}</td>
                <td>{{ route.uptime || '-' }}</td>
                <td>{{ route.tag }}</td>
                <td>
                  <button mat-icon-button matTooltip="Add Route to Wan Form" (click)="addRouteToWanForm(route)">
                    <mat-icon>playlist_add</mat-icon>
                  </button>
                </td>
              </tr>
            </ng-container>
            <ng-template #noData>
              <tr>
                <td colspan="7" class="text-center">No routes available</td>
              </tr>
            </ng-template>
          </tbody>
        </table>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>

<app-external-route-modal></app-external-route-modal>
