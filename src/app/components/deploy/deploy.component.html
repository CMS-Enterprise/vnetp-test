<h1>Deploy Tiers</h1>

<table class="table table-striped table-sm table-bordered">
  <caption>
    <fa-icon class="icon" [icon]="['fas', 'table']"></fa-icon>
    <span>Select which Tiers to Deploy</span>
  </caption>
  <thead>
    <tr>
      <th scope="col">Deploy</th>
      <th scope="col">Name</th>
      <th scope="col">Last Provisioned At</th>
      <th scope="col">Class</th>
      <th scope="col">Type</th>
      <th scope="col">Tier Group</th>
      <th scope="col">State</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    @for (tier of tiers; track tier) {
    <tr>
      <td>
        <input aria-label="tierSelected" (keyup.enter)="tier.isSelected = !tier.isSelected" type="checkbox" [(ngModel)]="tier.isSelected" />
      </td>
      <td>
        {{ tier?.item?.name }}
      </td>
      <td>
        {{ tier?.item?.provisionedAt }}
      </td>
      <td>
        {{ tier?.item?.tierClass }}
      </td>
      <td>
        {{ tier?.item?.tierType }}
      </td>
      <td>
        {{ tier?.item?.tierGroupId | resolve : getTierGroupName }}
      </td>
      <td>
        {{ tier?.item?.provisionedAt ? 'Provisioned' : 'Not Provisioned' }}
      </td>
      <td>
        @if (checkUndeployedChanges(tier?.item)) {
        <app-icon-button
          icon="asterisk"
          label="Undeployed Changes"
          [type]="'info'"
          (handleClick)="getChangeReport(tier.item)"
        ></app-icon-button>
        }
      </td>
    </tr>
    } @if (!tiers?.length) {
    <tr class="text-center">
      <td colspan="7">No Tiers to Provision</td>
    </tr>
    }
  </tbody>
</table>

<section class="btn-toolbar" role="toolbar">
  <button (keyup.enter)="(deployTiers)" class="btn btn-danger" (click)="deployTiers()">Deploy Selected Tiers</button>
</section>

<app-yes-no-modal></app-yes-no-modal>

<ngx-smart-modal #changeReportModal identifier="changeReportModal" [dismissable]="false" customClass="medium-modal">
  <header class="modal-header">
    <h4 class="modal-title">Undeployed Changes in Tier: {{ changeReport?.tier?.name }}</h4>
  </header>

  <div class="modal-body">
    <p class="mb-3">The following objects have changes:</p>

    @for (group of reportGroups; track group) { @if (group.data.length > 0) {
    <div class="scrollable-table-container" style="overflow-y: auto; max-height: 200px; margin-bottom: 20px">
      <span
        >{{ group.name }} <span class="badge bg-secondary">{{ group.data.length }}</span></span
      >
      <table class="table table-sm table-striped table-bordered">
        <caption>
          <fa-icon class="icon" [icon]="['fas', 'table']"></fa-icon>
          <span>{{ group?.name }}</span>
        </caption>
        <thead>
          <tr>
            <th>Name</th>
            <th>Last Updated At</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (obj of group.data; track obj) {
          <tr>
            <td>{{ obj.name }}</td>
            <td>{{ obj.updatedAt }}</td>
            <td>
              @if (obj.provisionedVersion === null) {
              <span>Not Provisioned</span>
              } @if (obj.provisionedVersion !== null) {
              <span>Updated</span>
              }
            </td>
            <td>
              <button class="btn btn-link p-0" (click)="getObjectAuditLogEvents(obj, group.type)">Show Diff</button>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
    } }
  </div>
</ngx-smart-modal>

<ngx-smart-modal #changeReportDetailModal identifier="changeReportDetailModal" [dismissable]="true" customClass="large-modal">
  <header class="modal-header">
    <h4 class="modal-title">Change Report Detail</h4>
  </header>

  <div class="modal-body">
    <div class="table-responsive" style="max-height: 400px; overflow-y: auto">
      <table class="table table-sm table-striped table-bordered">
        <caption>
          <fa-icon class="icon" [icon]="['fas', 'table']"></fa-icon>
          <span>Detailed Change Report</span>
        </caption>
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Timestamp</th>
            <th scope="col">Action Type</th>
            <th scope="col">Differences</th>
          </tr>
        </thead>
        <tbody>
          @for (entry of report; track entry; let i = $index) {
          <tr (click)="toggleExpand(i)" style="cursor: pointer">
            <td>{{ entry.name }}</td>
            <td>{{ entry.timestamp }}</td>
            <td>{{ entry.actionType }}</td>
            <td>
              <button class="btn btn-link p-0" (click)="$event.stopPropagation(); toggleExpand(i)">View Details</button>
            </td>
          </tr>
          @if (expandedRows.includes(i)) {
          <tr>
            <td colspan="4">
              @if (isArray(entry.differences)) {
              <div>
                <ul>
                  @for (diff of entry.differences; track diff) {
                  <li>
                    <strong>{{ diff.key }}:</strong> From "{{ diff.before }}" to "{{ diff.after }}"
                  </li>
                  }
                </ul>
              </div>
              } @else {
              {{ entry.differences }}
              }
            </td>
          </tr>
          } } @if (report.length === 0) {
          <tr>
            <td colspan="3" class="text-center">No Changes Detected</td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
</ngx-smart-modal>
