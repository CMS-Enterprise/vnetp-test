<h1>Deploy Tiers</h1>

<table class="table table-striped table-sm table-bordered">
  <caption>
    <fa-icon class="icon" [icon]="['fas', 'table']"></fa-icon>
    <span>Select which Tiers to Deploy</span>
  </caption>
  <thead>
    <tr>
      <th scope="col">Deploy</th>
      <th scope="col">Name</th>
      <th scope="col">Last Provisioned At</th>
      <th scope="col">Class</th>
      <th scope="col">Type</th>
      <th scope="col">Tier Group</th>
      <th scope="col">State</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let tier of tiers">
      <td>
        <input (keyup.enter)="tier.isSelected = !tier.isSelected" type="checkbox" [(ngModel)]="tier.isSelected" />
      </td>
      <td>
        {{ tier?.item?.name }}
      </td>
      <td>
        {{ tier?.item?.provisionedAt }}
      </td>
      <td>
        {{ tier?.item?.tierClass }}
      </td>
      <td>
        {{ tier?.item?.tierType }}
      </td>
      <td>
        {{ tier?.item?.tierGroupId | resolve : getTierGroupName }}
      </td>
      <td>
        {{ tier?.item?.provisionedAt ? 'Provisioned' : 'Not Provisioned' }}
      </td>
      <td>
        <app-icon-button
          *ngIf="checkUndeployedChanges(tier?.item)"
          icon="asterisk"
          label="Undeployed Changes"
          [type]="'info'"
          (handleClick)="getChangeReport(tier.item)"
        ></app-icon-button>
      </td>
    </tr>
    <tr *ngIf="!tiers?.length" class="text-center">
      <td colspan="7">No Tiers to Provision</td>
    </tr>
  </tbody>
</table>

<section class="btn-toolbar" role="toolbar">
  <button (keyup.enter)="(deployTiers)" class="btn btn-danger" (click)="deployTiers()">Deploy Selected Tiers</button>
</section>

<app-yes-no-modal></app-yes-no-modal>

<ngx-smart-modal #changeReportModal identifier="changeReportModal" [dismissable]="false" customClass="medium-modal">
  <header class="modal-header">
    <h4 class="modal-title">Undeployed Changes in Tier: {{ changeReport?.tier?.name }}</h4>
  </header>

  <div class="modal-body">
    <p class="mb-3">The following objects have changes:</p>

    <ng-container *ngFor="let group of reportGroups">
      <ng-container *ngIf="group.data.length > 0">
        <div class="scrollable-table-container" style="overflow-y: auto; max-height: 200px; margin-bottom: 20px">
          <span
            >{{ group.name }} <span class="badge bg-secondary">{{ group.data.length }}</span></span
          >

          <table class="table table-sm table-striped table-bordered">
            <caption>
              <fa-icon class="icon" [icon]="['fas', 'table']"></fa-icon>
              <span>{{ group?.name }}</span>
            </caption>
            <thead>
              <tr>
                <th>Name</th>
                <th>Last Updated At</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let obj of group.data">
                <td>{{ obj.name }}</td>
                <td>{{ obj.updatedAt }}</td>
                <td>
                  <span *ngIf="obj.provisionedVersion === null">Not Provisioned</span>
                  <span *ngIf="obj.provisionedVersion !== null">Updated</span>
                </td>
                <td>
                  <button class="btn btn-link p-0" (click)="getObjectAuditLogEvents(obj, group.type)">Show Diff</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </ng-container>
    </ng-container>
  </div>
</ngx-smart-modal>

<ngx-smart-modal #changeReportDetailModal identifier="changeReportDetailModal" [dismissable]="true" customClass="large-modal">
  <header class="modal-header">
    <h4 class="modal-title">Change Report Detail</h4>
  </header>

  <div class="modal-body">
    <div class="table-responsive" style="max-height: 400px; overflow-y: auto">
      <table class="table table-sm table-striped table-bordered">
        <caption>
          <fa-icon class="icon" [icon]="['fas', 'table']"></fa-icon>
          <span>Detailed Change Report</span>
        </caption>
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Timestamp</th>
            <th scope="col">Action Type</th>
            <th scope="col">Differences</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let entry of report; let i = index">
            <tr (click)="toggleExpand(i)" style="cursor: pointer">
              <td>{{ entry.name }}</td>
              <td>{{ entry.timestamp }}</td>
              <td>{{ entry.actionType }}</td>
              <td>
                <button class="btn btn-link p-0" (click)="$event.stopPropagation(); toggleExpand(i)">View Details</button>
              </td>
            </tr>
            <tr *ngIf="expandedRows.includes(i)">
              <td colspan="4">
                <div *ngIf="isArray(entry.differences); else simpleText">
                  <ul>
                    <li *ngFor="let diff of entry.differences">
                      <strong>{{ diff.key }}:</strong> From "{{ diff.before }}" to "{{ diff.after }}"
                    </li>
                  </ul>
                </div>
                <ng-template #simpleText>{{ entry.differences }}</ng-template>
              </td>
            </tr>
          </ng-container>
          <tr *ngIf="report.length === 0">
            <td colspan="3" class="text-center">No Changes Detected</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</ngx-smart-modal>
