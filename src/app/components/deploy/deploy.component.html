<h1>Deploy Tiers</h1>

<table class="table table-striped table-sm table-bordered">
  <caption>
    <fa-icon class="icon" [icon]="['fas', 'table']"></fa-icon>
    <span>Select which Tiers to Deploy</span>
  </caption>
  <thead>
    <tr>
      <th scope="col">Deploy</th>
      <th scope="col">Name</th>
      <th scope="col">Last Provisioned At</th>
      <th scope="col">Class</th>
      <th scope="col">Type</th>
      <th scope="col">Tier Group</th>
      <th scope="col">State</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let tier of tiers">
      <td>
        <input (keyup.enter)="tier.isSelected = !tier.isSelected" type="checkbox" [(ngModel)]="tier.isSelected" />
      </td>
      <td>
        {{ tier?.item?.name }}
      </td>
      <td>
        {{ tier?.item?.provisionedAt}}
      </td>
      <td>
        {{ tier?.item?.tierClass }}
      </td>
      <td>
        {{ tier?.item?.tierType }}
      </td>
      <td>
        {{ tier?.item?.tierGroupId | resolve: getTierGroupName }}
      </td>
      <td>
        {{ tier?.item?.provisionedAt ? 'Provisioned' : 'Not Provisioned' }}
      </td>
      <td>
        <app-icon-button *ngIf="checkUndeployedChanges(tier?.item)" icon="asterisk" label="Undeployed Changes"
        [type]="'info'" (handleClick)=getChangeReport(tier.item)></app-icon-button>
      </td>
    </tr>
    <tr *ngIf="!tiers?.length" class="text-center">
      <td colspan="7">No Tiers to Provision</td>
    </tr>
  </tbody>
</table>

<section class="btn-toolbar" role="toolbar">
  <button (keyup.enter)="deployTiers" class="btn btn-danger" (click)="deployTiers()">
    Deploy Selected Tiers
  </button>
</section>

<app-yes-no-modal></app-yes-no-modal>

<ngx-smart-modal #undeployedChangesModal identifier="changeReportModal" [dismissable]="false" customClass="medium-modal">
  <header class="modal-header">
    <h4 class="modal-title">Undeployed Changes in Tier: {{ changeReport?.tier?.name }}</h4>
  </header>

  <div class="modal-body">
    <p class="mb-3">The following objects have changes:</p>
  
    <!-- Iterate over reportGroups -->
    <div *ngFor="let group of reportGroups">
      <div *ngIf="group.data.length > 0">
        <h5>{{ group.name }} <span class="badge bg-secondary">{{ group.data.length }}</span></h5>
        <ul>
          <li *ngFor="let obj of group.data">
            {{ obj.name }}
            <span *ngIf="obj.provisionedVersion === null">(Not Provisioned)</span>
            <span *ngIf="obj.provisionedVersion !== null">(Updated)</span>
          </li>
        </ul>
      </div>
    </div>
  </div>
  
</ngx-smart-modal>