<ngx-smart-modal
  #workflowViewModal
  identifier="workflowViewModal"
  [dismissable]="false"
  customClass="modal-dialog xxlarge-modal"
  (onOpen)="getData()"
  (onClose)="reset()"
>
  <div class="modal-header">
    <h5 class="modal-title" *ngIf="workflow">Workflow: {{ workflow.name }}</h5>
  </div>
  <div class="modal-body" *ngIf="workflow">
    <mat-tab-group animationDuration="0ms">
      <mat-tab label="Summary">
        <ng-template matTabContent>
          <div class="pt-3">
            <p><strong>ID:</strong> {{ workflow.id }}</p>
            <p>
              <strong>Status:</strong> <mat-chip>{{ workflow.status }}</mat-chip>
            </p>
            <p><strong>Terraform Module:</strong> {{ workflow.terraformModule }}</p>
            <p><strong>Approval Type:</strong> {{ workflow.approvalType }}</p>
            <p><strong>Created At:</strong> {{ workflow.createdAt | date : 'medium' }}</p>
            <p><strong>Updated At:</strong> {{ workflow.updatedAt | date : 'medium' }}</p>
            <p *ngIf="workflow.finishedAt"><strong>Finished At:</strong> {{ workflow.finishedAt | date : 'medium' }}</p>
          </div>
        </ng-template>
      </mat-tab>

      <mat-tab label="Global Validation Errors ({{ workflow.validationResult?.globalErrors?.length }})" *ngIf="workflow.validationResult?.globalErrors?.length > 0">
        <ng-template matTabContent>
          <div class="pt-3">
            <mat-card *ngFor="let error of workflow.validationResult.globalErrors">
              <mat-card-header>
                <mat-card-title>{{ error.type }}</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <p>Message:</p>
                <p>{{ error.message }}</p>
                <p>Context:</p>
                <pre class="context-object">{{ error.context | json }}</pre>
              </mat-card-content>
            </mat-card>
          </div>
        </ng-template>
      </mat-tab>

      <mat-tab label="Audit Log Results ({{ workflow.validationResult?.auditLogResults?.length }})" *ngIf="workflow.validationResult?.auditLogResults?.length > 0">
        <ng-template matTabContent>
          <div class="pt-3">
            <mat-accordion>
              <mat-expansion-panel *ngFor="let item of workflow.validationResult.auditLogResults">
                <mat-expansion-panel-header>
                  <mat-panel-title> {{ item.mergedAuditLog.entityType }}: {{ item.mergedAuditLog.entityName }} ({{ item.mergedAuditLog.entityId }}) </mat-panel-title>
                  <mat-panel-description>
                    <span
                      >Status: <mat-chip [class]="'status-' + item.processingStatus">{{ item.processingStatus }}</mat-chip></span
                    >
                    <span>
                      Matched Terraform Resource Actions: {{ item.terraformResourceChanges?.length }}
                    </span>
                    <span *ngIf="item.mergedAuditLog.expectedTerraformAction" class="ml-2"
                      >Expected Action: <mat-chip>{{ item.mergedAuditLog.expectedTerraformAction }}</mat-chip></span
                    >
                  </mat-panel-description>
                </mat-expansion-panel-header>

                <div *ngIf="item.statusReason" class="mb-3"><strong>Status Reason:</strong> {{ item.statusReason }}</div>

                <div *ngIf="item.validationErrors?.length > 0" class="mb-3">
                  <h6>Validation Errors</h6>
                  <mat-card *ngFor="let error of item.validationErrors" class="mb-2">
                    <mat-card-header>
                      <mat-card-title>{{ error.type }}</mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                      <p>{{ error.message }}</p>
                      <pre *ngIf="error.context" class="context-object">{{ error.context | json }}</pre>
                    </mat-card-content>
                  </mat-card>
                </div>

                <div *ngIf="item.terraformResourceChanges?.length > 0">
                  <h6>Terraform Resource Changes</h6>
                  <table mat-table [dataSource]="item.terraformResourceChanges" class="mat-elevation-z2 terraform-changes-table">
                    <ng-container matColumnDef="actions" class="mat-column-actions">
                      <th mat-header-cell *matHeaderCellDef>Actions</th>
                      <td mat-cell *matCellDef="let element">
                        <mat-chip>{{ element.actions }}</mat-chip>
                      </td>
                    </ng-container>

                    <ng-container matColumnDef="address" class="mat-column-address">
                      <th mat-header-cell *matHeaderCellDef>Address</th>
                      <td mat-cell *matCellDef="let element">{{ element.address }}</td>
                    </ng-container>

                    <ng-container matColumnDef="type" class="mat-column-type">
                      <th mat-header-cell *matHeaderCellDef>Type</th>
                      <td mat-cell *matCellDef="let element">{{ element.type }}</td>
                    </ng-container>

                    <ng-container matColumnDef="name" class="mat-column-name">
                      <th mat-header-cell *matHeaderCellDef>Name</th>
                      <td mat-cell *matCellDef="let element">{{ element.name }}</td>
                    </ng-container>

                    <ng-container matColumnDef="diff" class="mat-column-diff">
                      <th mat-header-cell *matHeaderCellDef>Property Diff</th>
                      <td mat-cell *matCellDef="let element">
                        <pre>{{ element.diff | json }}</pre>
                      </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
                  </table>
                </div>
              </mat-expansion-panel>
            </mat-accordion>
          </div>
        </ng-template>
      </mat-tab>

      <mat-tab label="Unmatched Terraform Changes ({{ workflow.validationResult?.unmatchedTerraformChanges?.length }})" *ngIf="workflow.validationResult?.unmatchedTerraformChanges?.length > 0">
        <ng-template matTabContent>
          <div class="pt-3">
            <div class="alert alert-warning mb-3">
              <strong>Notice:</strong> These terraform changes could not be matched to any audit log but are not resource_drift. This
              indicates missing audit log entries or validation rule issues.
            </div>
            <table
              mat-table
              [dataSource]="workflow.validationResult.unmatchedTerraformChanges"
              class="mat-elevation-z2 terraform-changes-table"
            >
              <ng-container matColumnDef="actions" class="mat-column-actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let element">
                  <mat-chip>{{ element.actions }}</mat-chip>
                </td>
              </ng-container>

              <ng-container matColumnDef="address" class="mat-column-address">
                <th mat-header-cell *matHeaderCellDef>Address</th>
                <td mat-cell *matCellDef="let element">{{ element.address }}</td>
              </ng-container>

              <ng-container matColumnDef="type" class="mat-column-type">
                <th mat-header-cell *matHeaderCellDef>Type</th>
                <td mat-cell *matCellDef="let element">{{ element.type }}</td>
              </ng-container>

              <ng-container matColumnDef="name" class="mat-column-name">
                <th mat-header-cell *matHeaderCellDef>Name</th>
                <td mat-cell *matCellDef="let element">{{ element.name }}</td>
              </ng-container>

              <ng-container matColumnDef="diff" class="mat-column-diff">
                <th mat-header-cell *matHeaderCellDef>Property Diff</th>
                <td mat-cell *matCellDef="let element">
                  <pre>{{ element.diff | json }}</pre>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
            </table>
          </div>
        </ng-template>
      </mat-tab>

      <mat-tab label="Events ({{ workflow.events?.length }})" *ngIf="workflow.events?.length > 0">
        <ng-template matTabContent>
          <div class="pt-3">
            <div class="timeline">
              <div class="timeline-item" *ngFor="let event of workflow.events; trackBy: trackByEventId">
                <div class="timeline-content">
                  <div class="timeline-header">
                    <strong>{{ event.status | titlecase }}</strong>
                    <small class="text-muted ml-2">{{ event.timestamp | date : 'medium' }}</small>
                  </div>
                  <div class="timeline-body">
                    <p><strong>User:</strong> {{ event.user }}</p>
                    <p><strong>Event ID:</strong> {{ event.id }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-template>
      </mat-tab>

      <mat-tab label="Execution Logs ({{ workflow.executionLogs?.length }})" *ngIf="workflow.executionLogs?.length > 0">
        <ng-template matTabContent>
          <div class="pt-3">
            <mat-accordion>
              <mat-expansion-panel *ngFor="let log of workflow.executionLogs; trackBy: trackByExecutionLogId">
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    Terraform {{ log.executionType | titlecase }}
                  </mat-panel-title>
                  <mat-panel-description>
                    <span>Lines: {{ log.lineCount }}</span>
                    <span class="ml-2">{{ log.startedAt | date : 'medium' }}</span>
                  </mat-panel-description>
                </mat-expansion-panel-header>

                <div class="execution-log-details mb-3">
                  <p><strong>Execution Type:</strong> {{ log.executionType | titlecase }}</p>
                  <p><strong>Started At:</strong> {{ log.startedAt | date : 'medium' }}</p>
                  <p *ngIf="log.completedAt"><strong>Completed At:</strong> {{ log.completedAt | date : 'medium' }}</p>
                  <p *ngIf="log.jobId"><strong>AAP Job ID:</strong> {{ log.jobId }}</p>
                  <p><strong>Line Count:</strong> {{ log.lineCount }}</p>
                </div>

                <div class="execution-log-content">
                  <label for="log-content-{{ log.id }}" class="form-label"><strong>Log Content:</strong></label>
                  <textarea
                    id="log-content-{{ log.id }}"
                    class="form-control execution-log-textarea"
                    readonly
                    rows="20"
                    [value]="log.logContent"
                  ></textarea>
                </div>
              </mat-expansion-panel>
            </mat-accordion>
          </div>
        </ng-template>
      </mat-tab>

      <mat-tab label="Terraform Plan" *ngIf="workflow.plan?.planJson">
        <ng-template matTabContent>
          <div class="pt-3">
            <div *ngIf="terraformPlan">
              <!-- Plan Summary -->
              <mat-card class="mb-3">
                <mat-card-header>
                  <mat-card-title>Summary</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div class="row">
                    <div class="col-md-6">
                      <p class="mb-2"><strong>Format Version:</strong> {{ terraformPlan.format_version }}</p>
                      <p class="mb-2">
                        <strong>Terraform Version:</strong> {{ terraformPlan.terraform_version }}
                        <span
                          *ngIf="terraformPlan.prior_state"
                          class="prior-state-value"
                          [class.text-muted]="!hasTerraformVersionMismatch()"
                          [class.text-danger]="hasTerraformVersionMismatch()"
                        >
                          (Prior Version:{{ terraformPlan.prior_state.terraform_version }})
                        </span>
                      </p>
                      <p class="mb-2" *ngIf="terraformPlan.timestamp"><strong>Plan Timestamp:</strong> {{ terraformPlan.timestamp | date : 'medium' }}</p>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group mb-3">
                        <label class="form-label"><strong>Applyable</strong></label>
                        <div class="form-control-plaintext">
                          <span
                            class="badge"
                            [class.badge-success]="terraformPlan.applyable"
                            [class.badge-secondary]="!terraformPlan.applyable"
                          >
                            {{ terraformPlan.applyable ? 'Yes' : 'No' }}
                          </span>
                        </div>
                      </div>
                      <div class="form-group mb-3">
                        <label class="form-label"><strong>Complete</strong></label>
                        <div class="form-control-plaintext">
                          <span
                            class="badge"
                            [class.badge-success]="terraformPlan.complete"
                            [class.badge-secondary]="!terraformPlan.complete"
                          >
                            {{ terraformPlan.complete ? 'Yes' : 'No' }}
                          </span>
                        </div>
                      </div>
                      <div class="form-group mb-3">
                        <label class="form-label"><strong>Errored</strong></label>
                        <div class="form-control-plaintext">
                          <span
                            class="badge"
                            [class.badge-danger]="terraformPlan.errored"
                            [class.badge-success]="!terraformPlan.errored"
                          >
                            {{ terraformPlan.errored ? 'Yes' : 'No' }}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </mat-card-content>
              </mat-card>

              <!-- JSON Viewer and Download Button -->
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <h5 class="mb-1">Plan Details</h5>
                  <small class="text-muted">
                    <a href="https://developer.hashicorp.com/terraform/internals/json-format" target="_blank" rel="noopener noreferrer">
                      Terraform JSON Format Reference
                    </a>
                  </small>
                </div>
                <button type="button" class="btn btn-outline-primary" (click)="downloadPlanJson()">
                  <fa-icon [icon]="['fas', 'download']" class="mr-2"></fa-icon>
                  Download JSON
                </button>
              </div>
              <div class="json-viewer-container">
                <ngx-json-viewer [json]="terraformPlan" [expanded]="false"></ngx-json-viewer>
              </div>
            </div>

            <div *ngIf="!terraformPlan" class="alert alert-warning">
              <strong>No Plan Available:</strong> Terraform plan data is not available for this workflow.
            </div>
          </div>
        </ng-template>
      </mat-tab>
    </mat-tab-group>
  </div>
  <div class="modal-footer">
    <button
      *ngIf="workflow?.approvalType === 'manual' && workflow?.status === 'valid_awaiting_manual_approval'"
      type="button"
      class="btn btn-success mr-2"
      (click)="approveWorkflow()"
    >
      Approve Workflow
    </button>
    <button
      *ngIf="workflow?.approvalType === 'manual' && workflow?.status === 'valid_awaiting_manual_approval'"
      type="button"
      class="btn btn-danger mr-2"
      (click)="disapproveWorkflow()"
    >
      Disapprove Workflow
    </button>
    <button *ngIf="workflow?.status === 'invalid_applyable'" type="button" class="btn btn-warning mr-2" (click)="approveWorkflow()">
      Approve Workflow (Override)
    </button>
    <button
      *ngIf="workflow?.approvalType === 'manual' && workflow?.status === 'approved'"
      type="button"
      class="btn btn-primary mr-2"
      (click)="applyWorkflow()"
    >
      Apply Workflow Plan
    </button>
    <button type="button" class="btn btn-secondary" (click)="workflowViewModal.close()">Close</button>
  </div>
</ngx-smart-modal>
