<ngx-smart-modal #endpointDisplayModal [identifier]="modalId" customClass="modal-lg">
  <div class="modal-header">
    <h5 class="modal-title">Endpoint Details</h5>
  </div>
  <div class="modal-body">
    <!-- EPG Context Display -->
    <ng-container *ngIf="displayContext === 'epg'">
      <p *ngIf="!processedModalData || processedModalData.length === 0">No endpoints to display.</p>
      <table class="table table-hover" *ngIf="processedModalData && processedModalData.length > 0">
        <thead>
          <tr>
            <th>MAC Address</th>
            <th>IP Addresses</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let endpoint of processedModalData; let i = index">
            <tr>
              <td>{{ endpoint.macAddress }}</td>
              <td>
                <button
                  class="btn btn-link btn-sm p-0"
                  (click)="toggleIpAddresses(endpoint)"
                  [attr.aria-expanded]="endpoint.isIpListExpanded"
                  [attr.aria-controls]="'epg-ipDetails-' + i"
                >
                  {{ endpoint.isIpListExpanded ? 'Hide' : 'Show' }} IPs ({{ endpoint.ipAddresses?.length || 0 }})
                </button>
              </td>
            </tr>
            <tr *ngIf="endpoint.isIpListExpanded" [id]="'epg-ipDetails-' + i">
              <td colspan="2">
                <div>
                  <table class="table table-sm table-borderless mb-0">
                    <tbody>
                      <tr *ngFor="let ip of endpoint.ipAddresses">
                        <td>{{ ip.address }}</td>
                      </tr>
                      <tr *ngIf="!endpoint.ipAddresses || endpoint.ipAddresses.length === 0">
                        <td>No IP addresses associated.</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </ng-container>

    <!-- ESG Context Display -->
    <ng-container *ngIf="displayContext === 'esg'">
      <p *ngIf="!processedModalData || processedModalData.length === 0">No EPGs or endpoints to display.</p>
      <div *ngIf="processedModalData && processedModalData.length > 0">
        <div *ngFor="let epg of processedModalData; let epgIndex = index" class="mb-3 epg-section">
          <h5>
            <button
              class="btn btn-link btn-sm p-0 text-left"
              type="button"
              (click)="toggleEpgExpansion(epg)"
              [attr.aria-expanded]="epg.isEpgExpanded"
              [attr.aria-controls]="'esg-epgDetails-' + epgIndex"
            >
              {{ epg.isEpgExpanded ? '▼' : '▶' }} EPG: {{ epg.epgName }} ({{ epg.endpoints?.length || 0 }} Endpoints)
            </button>
          </h5>
          <div *ngIf="epg.isEpgExpanded" [id]="'esg-epgDetails-' + epgIndex">
            <p *ngIf="!epg.endpoints || epg.endpoints.length === 0" class="pl-3">No endpoints in this EPG.</p>
            <table class="table table-hover table-sm ml-3" *ngIf="epg.endpoints && epg.endpoints.length > 0">
              <thead>
                <tr>
                  <th>MAC Address</th>
                  <th>IP Addresses</th>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngFor="let endpoint of epg.endpoints; let epIndex = index">
                  <tr>
                    <td>{{ endpoint.macAddress }}</td>
                    <td>
                      <button
                        class="btn btn-link btn-sm p-0"
                        (click)="toggleIpAddresses(endpoint)"
                        [attr.aria-expanded]="endpoint.isIpListExpanded"
                        [attr.aria-controls]="'esg-epg-' + epgIndex + '-ipDetails-' + epIndex"
                      >
                        {{ endpoint.isIpListExpanded ? 'Hide' : 'Show' }} IPs ({{ endpoint.ipAddresses?.length || 0 }})
                      </button>
                    </td>
                  </tr>
                  <tr *ngIf="endpoint.isIpListExpanded" [id]="'esg-epg-' + epgIndex + '-ipDetails-' + epIndex">
                    <td colspan="2">
                      <div>
                        <table class="table table-sm table-borderless mb-0">
                          <tbody>
                            <tr *ngFor="let ip of endpoint.ipAddresses">
                              <td>{{ ip.address }}</td>
                            </tr>
                            <tr *ngIf="!endpoint.ipAddresses || endpoint.ipAddresses.length === 0">
                              <td>No IP addresses associated.</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </td>
                  </tr>
                </ng-container>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </ng-container>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="endpointDisplayModal.close()">Close</button>
  </div>
</ngx-smart-modal>
