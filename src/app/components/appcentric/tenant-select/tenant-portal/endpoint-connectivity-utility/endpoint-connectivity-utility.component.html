<div class="container">
  <div class="header">
    <h1>Endpoint Connectivity Utility</h1>
  </div>

  <div class="content">
    <div class="connectivity-form">
      <h2>Test Endpoint Connectivity</h2>

      <form [formGroup]="connectivityForm" (ngSubmit)="onSubmit()">
        <div class="form-group">
          <label for="sourceEndpointIp">Source IP</label>
          <input type="text" id="sourceEndpointIp" formControlName="sourceEndpointIp" placeholder="e.g. 10.0.0.1" />
          <div class="error" *ngIf="connectivityForm.get('sourceEndpointIp')?.invalid && connectivityForm.get('sourceEndpointIp')?.touched">
            Please enter a valid IP address
          </div>
        </div>

        <div class="form-group">
          <label for="sourceEndpointPort">Source Port (Optional)</label>
          <input type="number" id="sourceEndpointPort" formControlName="sourceEndpointPort" placeholder="e.g. 80" />
        </div>

        <div class="form-group">
          <label for="destinationEndpointIp">Destination IP</label>
          <input type="text" id="destinationEndpointIp" formControlName="destinationEndpointIp" placeholder="e.g. 10.0.0.2" />
          <div
            class="error"
            *ngIf="connectivityForm.get('destinationEndpointIp')?.invalid && connectivityForm.get('destinationEndpointIp')?.touched"
          >
            Please enter a valid IP address
          </div>
        </div>

        <div class="form-group">
          <label for="destinationEndpointPort">Destination Port</label>
          <input type="number" id="destinationEndpointPort" formControlName="destinationEndpointPort" placeholder="e.g. 443" />
          <div
            class="error"
            *ngIf="connectivityForm.get('destinationEndpointPort')?.invalid && connectivityForm.get('destinationEndpointPort')?.touched"
          >
            Please enter a valid port number
          </div>
        </div>

        <div class="form-group">
          <label for="ipProtocol">Protocol</label>
          <select id="ipProtocol" formControlName="ipProtocol">
            <option *ngFor="let protocol of protocolOptions" [value]="protocol">
              {{ protocol.toUpperCase() }}
            </option>
          </select>
        </div>

        <div class="form-options">
          <div class="checkbox-group">
            <input type="checkbox" id="bypassServiceGraph" formControlName="bypassServiceGraph" />
            <label for="bypassServiceGraph">Bypass Service Graph</label>
          </div>

          <div class="checkbox-group">
            <input type="checkbox" id="generateConfig" formControlName="generateConfig" />
            <label for="generateConfig">Generate Configuration</label>
          </div>

          <div class="checkbox-group">
            <input type="checkbox" id="applyConfig" formControlName="applyConfig" />
            <label for="applyConfig">Apply Configuration</label>
          </div>

          <div class="checkbox-group">
            <input type="checkbox" id="bidirectional" formControlName="bidirectional" />
            <label for="bidirectional">Test Bidirectional</label>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="resetForm()">Reset</button>
          <button type="submit" class="btn btn-primary" [disabled]="connectivityForm.invalid || isLoading">
            {{ isLoading ? 'Testing...' : 'Test Connectivity' }}
          </button>
        </div>
      </form>
    </div>

    <div class="connectivity-results" *ngIf="graph">
      <h2>Connectivity Results</h2>

      <div class="connection-status" [ngClass]="getStatusClass()">Connection: {{ getConnectionStatus() | uppercase }}</div>

      <div class="hierarchy-controls">
        <button class="btn btn-sm btn-outline-primary" (click)="expandAllNodes()">Expand All</button>
        <button class="btn btn-sm btn-outline-secondary" (click)="collapseAllNodes()">Collapse All</button>
      </div>

      <div class="hierarchy-visualization">
        <!-- Hierarchical view of tenants containing all objects -->
        <ng-container *ngFor="let tenant of getTenants()">
          <div class="hierarchy-node tenant-node">
            <!-- Tenant header with expand/collapse -->
            <div class="node-header" [ngClass]="{ expanded: isExpanded(tenant.id) }" (click)="toggleExpand(tenant.id)">
              <span class="expand-icon">{{ isExpanded(tenant.id) ? '▼' : '►' }}</span>
              <span class="node-type">Tenant</span>
              <span class="node-title">{{ tenant.name }}</span>
            </div>

            <!-- Tenant content - only visible if expanded -->
            <div class="node-content" *ngIf="isExpanded(tenant.id)">
              <div class="tenant-container">
                <!-- Consumer ESGs and their contents -->
                <div class="consumer-container">
                  <h3 class="column-title">Consumer</h3>
                  <ng-container *ngFor="let esg of getChildrenByType(tenant, 'esg')">
                    <div
                      class="hierarchy-node esg-node"
                      [ngClass]="{ 'active-path': isActivePathNode(esg.id) }"
                      *ngIf="getNodeRole(esg.id) === 'consumer'"
                    >
                      <div class="node-header" [ngClass]="{ expanded: isExpanded(esg.id) }" (click)="toggleExpand(esg.id)">
                        <span class="expand-icon">{{ isExpanded(esg.id) ? '▼' : '►' }}</span>
                        <span class="node-type">ESG</span>
                        <span class="node-title">{{ esg.name }}</span>
                        <span class="node-role consumer-role">CONSUMER</span>
                      </div>

                      <div class="node-content" *ngIf="isExpanded(esg.id)">
                        <!-- EPGs within the ESG -->
                        <ng-container *ngFor="let epg of getChildrenByType(esg, 'epg')">
                          <div class="hierarchy-node epg-node" [ngClass]="{ 'active-path': isActivePathNode(epg.id) }">
                            <div class="node-header" [ngClass]="{ expanded: isExpanded(epg.id) }" (click)="toggleExpand(epg.id)">
                              <span class="expand-icon">{{ isExpanded(epg.id) ? '▼' : '►' }}</span>
                              <span class="node-type">EPG</span>
                              <span class="node-title">{{ epg.name }}</span>
                              <span class="node-role consumer-role" *ngIf="getNodeRole(epg.id) === 'consumer'">CONSUMER</span>
                              <div class="relationship-indicators" *ngIf="isActivePathNode(epg.id) && getNodeRole(epg.id) === 'consumer'">
                                <div class="connection-indicator">
                                  <span class="indicator-label">Consumes from:</span>
                                  <span class="indicator-value">
                                    {{ findNodeInHierarchy(getRelatedNode(epg.id, 'provider'))?.name }}
                                  </span>
                                  <span class="arrow-right"></span>
                                </div>
                              </div>
                            </div>

                            <div class="node-content" *ngIf="isExpanded(epg.id)">
                              <!-- Endpoints within the EPG -->
                              <ng-container *ngFor="let endpoint of getChildrenByType(epg, 'endpoint')">
                                <div class="hierarchy-node endpoint-node" [ngClass]="{ 'active-path': isActivePathNode(endpoint.id) }">
                                  <div
                                    class="node-header"
                                    [ngClass]="{ expanded: isExpanded(endpoint.id) }"
                                    (click)="toggleExpand(endpoint.id)"
                                  >
                                    <span class="expand-icon">{{ isExpanded(endpoint.id) ? '▼' : '►' }}</span>
                                    <span class="node-type">ENDPOINT</span>
                                    <span class="node-title">{{ endpoint.metadata?.ipAddress }}</span>
                                  </div>

                                  <div class="node-content" *ngIf="isExpanded(endpoint.id)">
                                    <div class="endpoint-details">
                                      <div class="metadata-item" *ngFor="let item of getNodeMetadataDisplay(endpoint)">
                                        {{ item }}
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </ng-container>
                            </div>
                          </div>
                        </ng-container>
                      </div>
                    </div>
                  </ng-container>
                </div>

                <!-- Contracts and relationship arrows -->
                <div class="contracts-container">
                  <h3 class="column-title">Contract</h3>
                  <ng-container *ngFor="let contract of getChildrenByType(tenant, 'contract')">
                    <div class="hierarchy-node contract-node" [ngClass]="{ 'active-path': isActivePathNode(contract.id) }">
                      <div class="node-header" [ngClass]="{ expanded: isExpanded(contract.id) }" (click)="toggleExpand(contract.id)">
                        <span class="expand-icon">{{ isExpanded(contract.id) ? '▼' : '►' }}</span>
                        <span class="node-type">CONTRACT</span>
                        <span class="node-title">{{ contract.name }}</span>
                      </div>

                      <div class="node-content" *ngIf="isExpanded(contract.id)">
                        <!-- Contract details -->
                        <div class="contract-details">
                          <div class="contract-flow">
                            <div class="flow-arrow consumer-flow">
                              <div class="arrow-label">Consumer</div>
                              <div class="flow-item">{{ getConsumers(contract)[0]?.name }}</div>
                            </div>

                            <div class="flow-arrow provider-flow">
                              <div class="arrow-label">Provider</div>
                              <div class="flow-item">{{ getProviders(contract)[0]?.name }}</div>
                            </div>
                          </div>

                          <!-- Subjects, Filters, and Filter Entries -->
                          <ng-container *ngFor="let subject of getChildrenByType(contract, 'subject')">
                            <div class="hierarchy-node subject-node">
                              <div class="node-header" [ngClass]="{ expanded: isExpanded(subject.id) }" (click)="toggleExpand(subject.id)">
                                <span class="expand-icon">{{ isExpanded(subject.id) ? '▼' : '►' }}</span>
                                <span class="node-type">SUBJECT</span>
                                <span class="node-title">{{ subject.name }}</span>
                              </div>

                              <div class="node-content" *ngIf="isExpanded(subject.id)">
                                <!-- Filters within the subject -->
                                <ng-container *ngFor="let filter of getChildrenByType(subject, 'filter')">
                                  <div class="hierarchy-node filter-node">
                                    <div
                                      class="node-header"
                                      [ngClass]="{ expanded: isExpanded(filter.id) }"
                                      (click)="toggleExpand(filter.id)"
                                    >
                                      <span class="expand-icon">{{ isExpanded(filter.id) ? '▼' : '►' }}</span>
                                      <span class="node-type">FILTER</span>
                                      <span class="node-title">{{ filter.name }}</span>
                                    </div>

                                    <div class="node-content" *ngIf="isExpanded(filter.id)">
                                      <!-- Filter entries -->
                                      <ng-container *ngFor="let entry of getChildrenByType(filter, 'filter_entry')">
                                        <div class="hierarchy-node filter-entry-node">
                                          <div
                                            class="node-header"
                                            [ngClass]="{ expanded: isExpanded(entry.id) }"
                                            (click)="toggleExpand(entry.id)"
                                          >
                                            <span class="expand-icon">{{ isExpanded(entry.id) ? '▼' : '►' }}</span>
                                            <span class="node-type">FILTER ENTRY</span>
                                            <span class="node-title">{{ entry.name }}</span>
                                          </div>

                                          <div class="node-content" *ngIf="isExpanded(entry.id)">
                                            <div class="filter-entry-details">
                                              <div class="metadata-item" *ngFor="let item of getNodeMetadataDisplay(entry)">
                                                {{ item }}
                                              </div>
                                            </div>
                                          </div>
                                        </div>
                                      </ng-container>
                                    </div>
                                  </div>
                                </ng-container>
                              </div>
                            </div>
                          </ng-container>
                        </div>
                      </div>
                    </div>
                  </ng-container>
                </div>

                <!-- Provider ESGs and their contents -->
                <div class="provider-container">
                  <h3 class="column-title">Provider</h3>
                  <ng-container *ngFor="let esg of getChildrenByType(tenant, 'esg')">
                    <div
                      class="hierarchy-node esg-node"
                      [ngClass]="{ 'active-path': isActivePathNode(esg.id) }"
                      *ngIf="getNodeRole(esg.id) === 'provider'"
                    >
                      <div class="node-header" [ngClass]="{ expanded: isExpanded(esg.id) }" (click)="toggleExpand(esg.id)">
                        <span class="expand-icon">{{ isExpanded(esg.id) ? '▼' : '►' }}</span>
                        <span class="node-type">ESG</span>
                        <span class="node-title">{{ esg.name }}</span>
                        <span class="node-role provider-role">PROVIDER</span>
                      </div>

                      <div class="node-content" *ngIf="isExpanded(esg.id)">
                        <!-- EPGs within the ESG -->
                        <ng-container *ngFor="let epg of getChildrenByType(esg, 'epg')">
                          <div class="hierarchy-node epg-node" [ngClass]="{ 'active-path': isActivePathNode(epg.id) }">
                            <div class="node-header" [ngClass]="{ expanded: isExpanded(epg.id) }" (click)="toggleExpand(epg.id)">
                              <span class="expand-icon">{{ isExpanded(epg.id) ? '▼' : '►' }}</span>
                              <span class="node-type">EPG</span>
                              <span class="node-title">{{ epg.name }}</span>
                              <span class="node-role provider-role" *ngIf="getNodeRole(epg.id) === 'provider'">PROVIDER</span>
                              <div class="relationship-indicators" *ngIf="isActivePathNode(epg.id) && getNodeRole(epg.id) === 'provider'">
                                <div class="connection-indicator">
                                  <span class="arrow-left"></span>
                                  <span class="indicator-label">Provides to:</span>
                                  <span class="indicator-value">
                                    {{ findNodeInHierarchy(getRelatedNode(epg.id, 'consumer'))?.name }}
                                  </span>
                                </div>
                              </div>
                            </div>

                            <div class="node-content" *ngIf="isExpanded(epg.id)">
                              <!-- Endpoints within the EPG -->
                              <ng-container *ngFor="let endpoint of getChildrenByType(epg, 'endpoint')">
                                <div class="hierarchy-node endpoint-node" [ngClass]="{ 'active-path': isActivePathNode(endpoint.id) }">
                                  <div
                                    class="node-header"
                                    [ngClass]="{ expanded: isExpanded(endpoint.id) }"
                                    (click)="toggleExpand(endpoint.id)"
                                  >
                                    <span class="expand-icon">{{ isExpanded(endpoint.id) ? '▼' : '►' }}</span>
                                    <span class="node-type">ENDPOINT</span>
                                    <span class="node-title">{{ endpoint.metadata?.ipAddress }}</span>
                                  </div>

                                  <div class="node-content" *ngIf="isExpanded(endpoint.id)">
                                    <div class="endpoint-details">
                                      <div class="metadata-item" *ngFor="let item of getNodeMetadataDisplay(endpoint)">
                                        {{ item }}
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </ng-container>
                            </div>
                          </div>
                        </ng-container>
                      </div>
                    </div>
                  </ng-container>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </div>

      <div class="error-message" *ngIf="error">
        <div class="alert alert-danger">
          {{ error }}
        </div>
      </div>
    </div>
  </div>
</div>
