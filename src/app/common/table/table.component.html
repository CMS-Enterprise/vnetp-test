<ng-container *ngIf="show">
  <div *ngIf="showSearchBar" class="d-flex align-items-end justify-content-between border-bottom">
    <div *ngIf="!config.hideSearchBar">
      <div class="d-flex">
        <app-search-bar
          (searchBarClearResults)="clearTableResults()"
          [columns]="searchColumns"
          (searchCriteria)="getObjectsAndFilter($event)"
        ></app-search-bar>
        <tooltip [message]="helpText?.CaseSensitive"></tooltip>
      </div>
    </div>
    <button *ngIf="!config.hideAdvancedSearch" type="button" class="btn btn-warning align-self-end" (click)="openAdvancedSearch($event)">
      <fa-icon [icon]="['fas', 'search-plus']"></fa-icon>
      <span>Advanced Search</span>
    </button>
  </div>
  <table class="table table-striped table-sm table-bordered">
    <caption>
      <fa-icon class="icon" [icon]="['fas', 'table']"></fa-icon>
      <span>{{ config.description }}</span>
    </caption>
    <thead>
      <tr>
        <th *ngFor="let column of config.columns" scope="col">{{ column.name }}</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngIf="data && data?.data?.length === 0" class="text-center">
        <td [attr.colspan]="config.columns.length">No Objects in this Table</td>
      </tr>
      <ng-template
        ngFor
        let-datum
        [ngForOf]="
          data?.data
            | paginate
              : { itemsPerPage: data?.total / data?.pageCount, currentPage: data?.page, id: uniqueTableId, totalItems: data?.total }
        "
      >
        <tr
          [ngStyle]="getRowStyle(datum)"
          (click)="handleRowClick($event, datum)"
          [class.expandableRow]="expandableRows"
          [attr.aria-expanded]="datum.expanded ? 'true' : 'false'"
          [ngClass]="{ expanded: datum.expanded }"
        >
          <td *ngFor="let column of config.columns">
            <ng-container *ngIf="column.property">{{ datum[column.property] }}</ng-container>
            <ng-container *ngIf="!column.property && column.value && !column.template">{{ column.value(datum) }}</ng-container>
            <ng-container *ngIf="!column.property && column.template">
              <ng-container *ngTemplateOutlet="column.template(); context: { datum: datum }"></ng-container>
            </ng-container>
          </td>
        </tr>

        <!-- Expanded Row -->
        <tr *ngIf="datum.expanded && expandableRows" [class.expanded]="datum.expanded" class="expandableContent">
          <td [attr.colspan]="config.columns.length">
            <!-- Wrapper for expandable rows and navigation -->
            <div class="expandable-row-container">
              <!-- Navigation controls -->
              <div *ngIf="isTemplateArray()" class="navigation-controls d-flex justify-content-center align-items-center">
                <app-icon-button icon="arrowLeft" (handleClick)="previousTemplate(datum)"></app-icon-button>
                <div class="dots">
                  <span
                    *ngFor="let template of config.expandableRows(); let i = index"
                    [class.active]="datum.currentTemplateIndex === i"
                    class="dot"
                  ></span>
                </div>
                <app-icon-button icon="arrowRight" (handleClick)="nextTemplate(datum)"></app-icon-button>
              </div>

              <!-- Template rendering based on currentTemplateIndex -->
              <ng-container *ngIf="isTemplateArray()">
                <ng-container
                  *ngTemplateOutlet="config.expandableRows()[datum.currentTemplateIndex]; context: { datum: datum }"
                ></ng-container>
              </ng-container>

              <!-- If only a single template is provided -->
              <ng-container *ngIf="!isTemplateArray()">
                <ng-container *ngTemplateOutlet="config.expandableRows(); context: { datum: datum }"></ng-container>
              </ng-container>
            </div>
          </td>
        </tr>
      </ng-template>
    </tbody>
    <tfoot *ngIf="paginationControlsOn">
      <td [attr.colspan]="config.columns.length">
        <pagination-controls
          *ngIf="paginationControlsOn"
          [id]="uniqueTableId"
          (pageChange)="currentPage = $event; onTableEvent()"
        ></pagination-controls>
        <span
          *ngIf="show"
          class="badge badge-pill badge-secondary ml-2 py-1 px-2 align-middle"
          style="font-size: 0.8em; vertical-align: middle"
          >{{ hasSearchResults ? 'Matched Entries' : 'Current Entries' }}: {{ data?.total }}</span
        >
      </td>
    </tfoot>
  </table>
  <section *ngIf="paginationControlsOn" class="btn-toolbar btn-toolbar--start">
    <span class="mr-3">Entities per page</span>
    <div class="btn-group" role="group">
      <button type="button" value="20" (click)="itemsPerPage = $event.target.value; onTableEvent()" class="btn btn-light">20</button>
      <button
        *ngIf="data?.total >= 50"
        type="button"
        value="50"
        (click)="itemsPerPage = $event.target.value; onTableEvent()"
        class="btn btn-light"
      >
        50
      </button>
      <button
        *ngIf="data?.total >= 100"
        type="button"
        value="100"
        (click)="itemsPerPage = $event.target.value; onTableEvent()"
        class="btn btn-light"
      >
        100
      </button>
    </div>
  </section>
</ng-container>

<app-advanced-search-modal
  *ngIf="!config.hideAdvancedSearch"
  [advancedSearchAdapterSubject]="advancedSearchAdapterSubject"
  (advancedSearchResults)="setAdvancedSearchData($event)"
  [formInputs]="searchColumns"
></app-advanced-search-modal>
